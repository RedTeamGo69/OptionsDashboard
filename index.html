<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Odyssey - Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.4/plugin/quarterOfYear.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.4/plugin/weekOfYear.js"></script>
    <style>
        /* Custom scrollbar for better dark mode aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .modal-content {
            max-height: 90vh;
        }
        /* Responsive calendar day height */
        .calendar-day {
            min-height: 5rem;
        }
         .toggle-bg:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            background-color: white;
            border-radius: 9999px;
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 0.2s ease-in-out;
        }
        input:checked + .toggle-bg:after {
            transform: translateX(100%);
        }
        .calendar-pnl-text {
            font-size: 0.65rem; /* approx 10.4px */
            line-height: 0.8rem;
            word-break: break-all;
        }

        @media (min-width: 640px) { /* sm breakpoint */
            .calendar-pnl-text {
                font-size: 0.75rem; /* back to text-xs */
                line-height: 1rem;
            }
            .calendar-day {
                min-height: 6rem;
            }
        }
        /* Make chart bars clickable */
        #pnlByStrategyChart, #pnlByTickerChart, #pnlByTagChart, #pnlByDayChart, #pnlDistributionChart {
            cursor: pointer;
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">
    <div id="app" class="p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex flex-wrap justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-white flex items-center gap-3">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 12C4 7.58172 7.58172 4 12 4C16.4183 4 20 7.58172 20 12C20 16.4183 16.4183 20 12 20" stroke="#818cf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14Z" stroke="#a78bfa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 4V2" stroke="#818cf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M20 12L22 12" stroke="#818cf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 20V22" stroke="#818cf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Options Odyssey</span>
                </h1>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
                <button id="importTradesBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Import
                </button>
                 <button id="addTransactionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    Transaction
                </button>
                <button id="addTradeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    New Trade
                </button>
                 <button id="settings-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    Settings
                </button>
                 <button id="resetDataBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    Reset
                </button>
            </div>
        </header>

        <!-- Account Value & Settings -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <div class="bg-gray-800 p-5 rounded-xl shadow-lg flex flex-col justify-between">
                 <div id="account-switcher" class="flex flex-wrap items-center gap-2 mb-4 border-b border-gray-700 pb-4">
                     <!-- Account tabs will be injected here -->
                 </div>
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center w-full gap-4">
                    <div>
                        <h3 class="text-sm font-medium text-gray-400">Total Account Value</h3>
                        <p id="total-account-value" class="text-3xl sm:text-4xl font-bold text-white mt-1">$0.00</p>
                    </div>
                    <div class="text-left sm:text-right w-full sm:w-auto">
                        <p class="text-sm font-medium text-gray-400">Total Deposits</p>
                        <p id="total-deposits" class="text-lg font-semibold text-blue-400">$0.00</p>
                        <p class="text-sm font-medium text-gray-400 mt-2">Total Withdrawals</p>
                        <p id="total-withdrawals" class="text-lg font-semibold text-orange-400">$0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- KPIs -->
            <div class="bg-gray-800 p-5 rounded-xl shadow-lg col-span-1 flex flex-col justify-center">
                <div>
                    <h3 class="text-sm font-medium text-gray-400">Total P&L</h3>
                    <p id="kpi-total-pnl" class="text-2xl sm:text-3xl font-bold text-green-400 mt-1">$0.00</p>
                </div>
            </div>
            <div class="bg-gray-800 p-5 rounded-xl shadow-lg col-span-1 flex flex-col justify-center">
                <div>
                    <h3 class="text-sm font-medium text-gray-400">Win Rate</h3>
                    <p id="kpi-win-rate" class="text-2xl sm:text-3xl font-bold text-white mt-1">0%</p>
                </div>
            </div>
            <div class="bg-gray-800 p-5 rounded-xl shadow-lg col-span-1 flex flex-col justify-center">
                <div>
                    <h3 class="text-sm font-medium text-gray-400">Average ROC %</h3>
                    <p id="kpi-avg-roc" class="text-2xl sm:text-3xl font-bold text-white mt-1">0.0%</p>
                </div>
            </div>
            <div class="bg-gray-800 p-5 rounded-xl shadow-lg col-span-1 flex flex-col justify-center">
                <div>
                    <h3 class="text-sm font-medium text-gray-400">Trades</h3>
                    <p id="kpi-total-trades" class="text-2xl sm:text-3xl font-bold text-white mt-1">0</p>
                </div>
            </div>

            <!-- Visualizations -->
            <div class="bg-gray-800 p-5 rounded-xl shadow-lg col-span-1 md:col-span-2 lg:col-span-3">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <div class="flex items-center gap-4">
                        <h3 class="text-lg font-semibold text-white">P&L View</h3>
                        <!-- P&L Chart Type Toggle -->
                        <div id="pnl-chart-toggle" class="flex items-center gap-1 bg-gray-900/50 rounded-lg p-1">
                            <button data-chart-type="line" class="pnl-chart-btn text-xs px-3 py-1 rounded-md transition">Curve</button>
                            <button data-chart-type="bar" class="pnl-chart-btn text-xs px-3 py-1 rounded-md transition">Bars</button>
                        </div>
                    </div>
                     <div class="flex items-center gap-4 flex-wrap">
                        <select id="equity-curve-filter-select" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <option value="all">All Time</option>
                            <option value="ytd">Year to Date (YTD)</option>
                            <option value="qtd">This Quarter (QTD)</option>
                            <option value="mtd">This Month (MTD)</option>
                            <option value="this-week">This Week</option>
                            <option value="today">Today</option>
                            <option value="custom">Custom...</option>
                        </select>
                    </div>
                </div>
                <div id="custom-date-filter-wrapper" class="hidden flex items-center gap-4 mb-4 p-3 bg-gray-900/50 rounded-lg">
                    <div class="flex items-center gap-2">
                         <label for="custom-start-date" class="text-sm text-gray-400">From:</label>
                         <input type="date" id="custom-start-date" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div class="flex items-center gap-2">
                         <label for="custom-end-date" class="text-sm text-gray-400">To:</label>
                         <input type="date" id="custom-end-date" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                </div>
                <div class="relative h-80 sm:h-96">
                    <canvas id="pnlCurveChart"></canvas>
                </div>
            </div>
            <div class="bg-gray-800 p-5 rounded-xl shadow-lg col-span-1 md:col-span-2 lg:col-span-1">
                <h3 id="performance-stats-title" class="text-lg font-semibold text-white mb-4">Performance Stats (All Time)</h3>
                <div id="performance-stats" class="space-y-3 pt-2 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Avg Win / Avg Loss</span>
                        <div>
                            <span id="stats-avg-win" class="font-semibold text-green-400">$0.00</span>
                            <span class="text-gray-500"> / </span>
                            <span id="stats-avg-loss" class="font-semibold text-red-400">$0.00</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Largest Win / Loss</span>
                         <div>
                            <span id="stats-largest-win" class="font-semibold text-green-400">$0.00</span>
                            <span class="text-gray-500"> / </span>
                            <span id="stats-largest-loss" class="font-semibold text-red-400">$0.00</span>
                        </div>
                    </div>
                     <div class="flex justify-between items-center">
                        <span class="text-gray-400">Profit Factor</span>
                        <span id="stats-profit-factor" class="font-semibold text-white">0.00</span>
                    </div>
                     <div class="flex justify-between items-center">
                        <span class="text-gray-400">Expectancy</span>
                        <span id="stats-expectancy" class="font-semibold text-white">$0.00</span>
                    </div>
                     <div class="flex justify-between items-center">
                        <span class="text-gray-400">Max Drawdown</span>
                        <span id="stats-max-drawdown" class="font-semibold text-white">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Avg Holding Period</span>
                        <span id="stats-avg-hold" class="font-semibold text-white">0 days</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Longest Win Streak</span>
                        <span id="stats-win-streak" class="font-semibold text-white">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Longest Loss Streak</span>
                        <span id="stats-loss-streak" class="font-semibold text-white">0</span>
                    </div>
                     <div class="flex justify-between items-center">
                        <span class="text-gray-400">Total Commissions</span>
                        <span id="stats-total-comm" class="font-semibold text-white">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Toggleable Main View: Calendar / Strategy -->
            <div class="bg-gray-800 p-5 rounded-xl shadow-lg md:col-span-2 lg:col-span-4">
                 <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                     <div class="flex flex-wrap items-center gap-4">
                        <h3 id="main-view-title" class="text-lg font-semibold text-white">Trading Calendar</h3>
                        <div id="calendar-controls-wrapper" class="flex items-center justify-between w-full sm:w-auto">
                            <button id="prev-period" class="bg-gray-700 p-2 rounded-lg hover:bg-gray-600 transition">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                             <span id="calendar-period-label" class="font-semibold text-base sm:text-lg mx-2 text-center">October 2025</span>
                            <button id="next-period" class="bg-gray-700 p-2 rounded-lg hover:bg-gray-600 transition">
                               <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2" id="main-view-toggle">
                       <button data-view="calendar" class="main-view-btn bg-indigo-600 text-white py-1 px-3 rounded-lg text-sm transition">Calendar</button>
                       <button data-view="strategy" class="main-view-btn bg-gray-700 hover:bg-gray-600 text-gray-300 py-1 px-3 rounded-lg text-sm transition">Strategy</button>
                       <button data-view="analytics" class="main-view-btn bg-gray-700 hover:bg-gray-600 text-gray-300 py-1 px-3 rounded-lg text-sm transition">Analytics</button>
                    </div>
                </div>

                <!-- Calendar View -->
                <div id="calendar-view">
                     <div class="flex flex-wrap items-center gap-4 mb-4">
                        <div id="calendar-view-toggle-buttons" class="flex items-center gap-2">
                           <button data-view="month" class="calendar-view-btn bg-indigo-600 text-white py-1 px-3 rounded-lg text-sm transition">Month</button>
                           <button data-view="week" class="calendar-view-btn bg-gray-700 hover:bg-gray-600 text-gray-300 py-1 px-3 rounded-lg text-sm transition">Week</button>
                        </div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
                    <div id="calendar-summary" class="text-right mt-2 text-sm text-gray-400"></div>
                </div>

                <!-- Strategy View -->
                <div id="strategy-view" class="hidden relative h-96">
                    <canvas id="pnlByStrategyChart"></canvas>
                </div>

                <!-- Analytics View -->
                <div id="analytics-view" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-900/50 p-4 rounded-lg">
                        <h4 class="text-md font-semibold text-white mb-3">P&L by Ticker</h4>
                        <div class="relative h-64"><canvas id="pnlByTickerChart"></canvas></div>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-lg">
                        <h4 class="text-md font-semibold text-white mb-3">P&L by Tag</h4>
                        <div class="relative h-64"><canvas id="pnlByTagChart"></canvas></div>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-lg">
                        <h4 class="text-md font-semibold text-white mb-3">P&L by Day of Week</h4>
                        <div class="relative h-64"><canvas id="pnlByDayChart"></canvas></div>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-lg">
                        <h4 class="text-md font-semibold text-white mb-3">P&L Distribution</h4>
                        <div class="relative h-64"><canvas id="pnlDistributionChart"></canvas></div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Trades Table -->
            <div class="bg-gray-800 p-5 rounded-xl shadow-lg col-span-1 md:col-span-2 lg:col-span-4">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-y-4">
                    <div class="flex items-center gap-4 flex-wrap">
                        <h3 class="text-lg font-semibold text-white">Activity Log</h3>
                        <div id="chart-filter-display" class="hidden items-center gap-2 bg-gray-700 rounded-lg pr-2">
                            <span class="text-sm text-gray-300 pl-3 py-1"></span>
                            <button id="clear-chart-filter" class="text-red-400 hover:text-red-300 font-bold text-xl leading-none pb-1">&times;</button>
                        </div>
                        <div id="calendar-filter-info" class="hidden items-center gap-2 bg-gray-700 rounded-lg pr-2">
                           <span id="filtered-day-span" class="text-sm text-gray-300 pl-3 py-1"></span>
                           <button id="unfilter-day-btn" class="text-red-400 hover:text-red-300 font-bold text-xl leading-none pb-1" title="Clear date filter">&times;</button>
                        </div>
                    </div>
                    <div class="ml-auto flex items-center gap-4 flex-wrap">
                        <div id="trade-filters" class="flex items-center gap-2 flex-wrap">
                            <button data-filter="all" class="filter-btn bg-indigo-600 text-white py-1 px-3 rounded-lg text-sm transition">All</button>
                            <button data-filter="trades" class="filter-btn bg-gray-700 hover:bg-gray-600 text-gray-300 py-1 px-3 rounded-lg text-sm transition">Trades</button>
                            <button data-filter="deposits" class="filter-btn bg-gray-700 hover:bg-gray-600 text-gray-300 py-1 px-3 rounded-lg text-sm transition">Deposits</button>
                            <button data-filter="withdrawals" class="filter-btn bg-gray-700 hover:bg-gray-600 text-gray-300 py-1 px-3 rounded-lg text-sm transition">Withdrawals</button>
                            <button data-filter="winners" class="filter-btn bg-gray-700 hover:bg-gray-600 text-gray-300 py-1 px-3 rounded-lg text-sm transition">Winners</button>
                            <button data-filter="losers" class="filter-btn bg-gray-700 hover:bg-gray-600 text-gray-300 py-1 px-3 rounded-lg text-sm transition">Losers</button>
                        </div>
                         <div class="relative w-full sm:w-auto">
                            <input type="text" id="logSearch" class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-4 py-2 text-white text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Search Ticker or Tag...">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        </div>
                         <button id="exportCsvBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Export
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead id="activity-log-header">
                            <tr class="border-b border-gray-700 text-sm">
                                <th class="p-3 font-semibold">
                                    <button class="sort-btn flex items-center gap-1 hover:text-white transition" data-sort="date">Date<span class="sort-indicator"></span></button>
                                </th>
                                <th class="p-3 font-semibold">Type</th>
                                <th class="p-3 font-semibold">Description</th>
                                <th class="p-3 font-semibold text-right hidden md:table-cell">
                                     <button class="sort-btn flex items-center gap-1 w-full justify-end hover:text-white transition" data-sort="duration">Duration<span class="sort-indicator"></span></button>
                                </th>
                                <th class="p-3 font-semibold text-right">
                                     <button class="sort-btn flex items-center gap-1 w-full justify-end hover:text-white transition" data-sort="amount">Amount<span class="sort-indicator"></span></button>
                                </th>
                                <th class="p-3 font-semibold text-right hidden lg:table-cell">
                                     <button class="sort-btn flex items-center gap-1 w-full justify-end hover:text-white transition" data-sort="roc">ROC %<span class="sort-indicator"></span></button>
                                </th>
                                <th class="p-3 font-semibold text-right pr-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-trades-body">
                            <!-- Rows will be injected here -->
                        </tbody>
                        <tfoot>
                           <tr id="activity-log-footer" class="border-t-2 border-gray-600 font-bold"></tr>
                        </tfoot>
                    </table>
                </div>
                <div id="pagination-controls" class="flex justify-between items-center mt-4 text-sm"></div>
            </div>
        </main>

        <footer class="text-center py-8 text-gray-600 text-sm">
             <p>created by EllGeeQuu</p>
        </footer>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md modal-content overflow-y-auto">
            <form id="transactionForm" class="p-6 sm:p-8">
                <h2 class="text-2xl font-bold text-white mb-6">Log Transaction</h2>
                <div class="mb-4">
                    <label for="transaction_type" class="block text-sm font-medium text-gray-300 mb-1">Transaction Type</label>
                    <select id="transaction_type" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="deposit">Deposit</option>
                        <option value="withdrawal">Withdrawal</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="transaction_amount" class="block text-sm font-medium text-gray-300 mb-1">Amount</label>
                    <input type="number" step="0.01" id="transaction_amount" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="1000.00">
                </div>
                <div class="mb-4">
                    <label for="transaction_date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                    <input type="date" id="transaction_date" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                <div class="mb-6">
                    <label for="transaction_notes" class="block text-sm font-medium text-gray-300 mb-1">Notes</label>
                    <textarea id="transaction_notes" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="e.g., Contribution to account"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelTransactionBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Trade Entry Modal -->
    <div id="tradeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content overflow-y-auto">
            <form id="tradeForm" class="p-6 sm:p-8">
                <h2 id="modal-title" class="text-2xl font-bold text-white mb-6">Log New Trade</h2>
                <input type="hidden" id="trade_id">

                <!-- Trade Identity -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="underlying_ticker" class="block text-sm font-medium text-gray-300 mb-1">Underlying Ticker</label>
                        <input type="text" id="underlying_ticker" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="e.g., AAPL">
                    </div>
                    <div>
                        <label for="trade_type" class="block text-sm font-medium text-gray-300 mb-1">Trade Type</label>
                        <select id="trade_type" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <option>Long Call</option>
                            <option>Long Put</option>
                            <option>Short Call</option>
                            <option>Short Put</option>
                            <option>Long Call Spread</option>
                            <option>Long Put Spread</option>
                            <option>Short Call Spread</option>
                            <option>Short Put Spread</option>
                            <option>Calendar Spread</option>
                            <option>Long Ratio Spread</option>
                            <option>Short Ratio Spread</option>
                            <option>Long Straddle</option>
                            <option>Short Straddle</option>
                            <option>Long Strangle</option>
                            <option>Short Strangle</option>
                            <option>Long Butterfly</option>
                            <option>Short Butterfly</option>
                            <option>Short Iron Condor</option>
                            <option>Short Iron Butterfly</option>
                        </select>
                    </div>
                </div>

                <!-- Trade Execution -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="open_date" class="block text-sm font-medium text-gray-300 mb-1">Open Date</label>
                        <input type="date" id="open_date" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="close_date" class="block text-sm font-medium text-gray-300 mb-1">Close Date</label>
                        <input type="date" id="close_date" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                </div>
                
                <!-- Contract Details -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div id="expiration_date_container">
                        <label for="expiration_date" class="block text-sm font-medium text-gray-300 mb-1">Expiration Date</label>
                        <input type="date" id="expiration_date" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div id="expiration_date_2_container" class="hidden">
                        <label for="expiration_date_2" class="block text-sm font-medium text-gray-300 mb-1">Expiration Date 2</label>
                        <input type="date" id="expiration_date_2" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                </div>

                <div id="strike-price-container" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                    <!-- Strike price fields will be injected here -->
                </div>
                
                <div class="border-t border-gray-700/50 my-4"></div>
                
                <!-- Leg 1 Financials -->
                <div id="leg_1_container">
                    <h4 class="text-md font-semibold text-indigo-400 mb-3" id="leg_1_title">Financials</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-300 mb-1">Quantity</label>
                            <!-- Added step="1" -->
                            <input type="number" id="quantity" required min="1" step="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="5">
                        </div>
                        <div>
                            <label for="entry_price" class="block text-sm font-medium text-gray-300 mb-1">Entry Price</label>
                            <input type="number" step="0.01" id="entry_price" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="1.25">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="exit_price" class="block text-sm font-medium text-gray-300">Exit Price</label>
                                <label class="flex items-center text-xs text-gray-400 cursor-pointer">
                                    <input type="checkbox" id="expired_worthless" class="h-3 w-3 bg-gray-700 border border-gray-600 text-indigo-600 focus:ring-indigo-500 rounded">
                                    <span class="ml-1.5">Expired</span>
                                </label>
                            </div>
                            <input type="number" step="0.01" id="exit_price" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0.65">
                        </div>
                    </div>
                </div>

                <!-- Leg 2 Financials (for Ratios) -->
                <div id="ratio-inputs-container" class="hidden">
                    <h4 class="text-md font-semibold text-indigo-400 mb-3">Leg 2 Financials</h4>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="quantity_2" class="block text-sm font-medium text-gray-300 mb-1">Quantity 2</label>
                            <!-- Added step="1" -->
                            <input type="number" id="quantity_2" min="1" step="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="2">
                        </div>
                        <div>
                            <label for="entry_price_2" class="block text-sm font-medium text-gray-300 mb-1">Entry Price 2</label>
                            <input type="number" step="0.01" id="entry_price_2" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0.80">
                        </div>
                        <div>
                            <label for="exit_price_2" class="block text-sm font-medium text-gray-300 mb-1">Exit Price 2</label>
                            <input type="number" step="0.01" id="exit_price_2" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0.30">
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-700/50 my-4"></div>


                <div class="mb-4">
                    <label class="flex items-center text-sm font-medium text-gray-300 mb-2">
                        <input type="checkbox" id="separate_commissions" class="h-4 w-4 bg-gray-700 border border-gray-600 text-indigo-600 focus:ring-indigo-500 rounded">
                        <span class="ml-2">Use Separate Commissions</span>
                    </label>
                    <div id="single_commission_container">
                        <label for="commissions" class="block text-sm font-medium text-gray-300 mb-1">Commissions (Per Contract, Per Leg)</label>
                        <input type="number" step="0.01" id="commissions" value="0" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0.65">
                    </div>
                    <div id="separate_commissions_container" class="hidden grid grid-cols-2 gap-4">
                        <div>
                             <label for="opening_commission" class="block text-sm font-medium text-gray-300 mb-1">Opening Commission</label>
                             <input type="number" step="0.01" id="opening_commission" value="0" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0.65">
                        </div>
                        <div>
                             <label for="closing_commission" class="block text-sm font-medium text-gray-300 mb-1">Closing Commission</label>
                             <input type="number" step="0.01" id="closing_commission" value="0" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0.65">
                        </div>
                    </div>
                </div>


                <div class="mb-4">
                    <label for="max_risk" class="block text-sm font-medium text-gray-300 mb-1">Max Risk / Collateral</label>
                    <div class="flex">
                        <input type="number" step="1" id="max_risk" value="0" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="500">
                          <!-- Removed Auto Button -->
                    </div>
                </div>

                <!-- Notes & Tags -->
                <div class="mb-4">
                    <label for="notes" class="block text-sm font-medium text-gray-300 mb-1">Notes</label>
                    <textarea id="notes" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Trade thesis, management, etc."></textarea>
                </div>
                 <div class="mb-6">
                    <label for="tags" class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
                    <input type="text" id="tags" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="earnings, iv crush, spy (comma-separated)">
                </div>
                
                <!-- Footer -->
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Cancel</button>
                    <button type="submit" id="saveBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition">Save Trade</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Trades Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl modal-content overflow-y-auto">
            <div class="p-6 sm:p-8">
                <div class="flex justify-between items-start">
                    <h2 class="text-2xl font-bold text-white mb-4">Import Trades</h2>
                    <button type="button" id="cancelImportBtn" class="text-gray-400 hover:text-white">&times;</button>
                </div>

                <!-- Step 1: Upload File -->
                <div id="import-step-1">
                    <div class="bg-gray-900/50 p-4 rounded-lg mb-6">
                        <h3 class="font-semibold text-white mb-2">Instructions</h3>
                        <p class="text-gray-400 text-sm">
                            Upload your trades from any CSV file. On the next step, you'll match your file's columns to the dashboard's fields.
                        </p>
                    </div>
                    <div class="flex items-center gap-4 mb-4">
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                        <label for="csvFileInput" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition">Choose File</label>
                        <span id="fileName" class="text-gray-400 text-sm">No file selected</span>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button type="button" id="import-next-btn-1" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next: Map Columns</button>
                    </div>
                </div>

                <!-- Step 2: Map Columns -->
                <div id="import-step-2" class="hidden">
                    <p class="text-gray-400 text-sm mb-4">Match the dashboard fields to the columns from your uploaded file. We've tried to guess the best match.</p>
                    <div id="column-mapping-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4 max-h-96 overflow-y-auto p-4 bg-gray-900/50 rounded-lg">
                        <!-- Mapping rows will be injected here by JS -->
                    </div>
                    <div class="flex justify-between items-center mt-6">
                        <button type="button" id="import-back-btn-2" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Back</button>
                        <button type="button" id="import-next-btn-2" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition">Next: Preview Data</button>
                    </div>
                </div>

                <!-- Step 3: Preview and Confirm -->
                <div id="import-step-3" class="hidden">
                    <p class="text-gray-400 text-sm mb-4">Review your trades below. Rows in red have errors and will be skipped. Fix them in your original file and re-upload if necessary.</p>
                    <div id="import-preview-area" class="max-h-96 overflow-auto border border-gray-700 rounded-lg">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-700 sticky top-0"><tr id="import-preview-header"></tr></thead>
                            <tbody id="import-preview-body"></tbody>
                        </table>
                    </div>
                     <div id="import-summary" class="text-right text-sm mt-2 font-semibold"></div>
                    <div class="flex justify-between items-center mt-6">
                        <button type="button" id="import-back-btn-3" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Back</button>
                        <button type="button" id="confirmImportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">Confirm Import</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reset Data Modal -->
    <div id="resetModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md modal-content">
            <div class="p-6 sm:p-8">
                <h2 class="text-2xl font-bold text-red-400 mb-4">Reset Current Account</h2>
                <p class="text-gray-400 mb-6">This will permanently delete all trades and transactions for the <strong id="reset-account-name" class="text-white"></strong> account. This action cannot be undone. To confirm, type "RESET" below.</p>
                <input type="text" id="resetConfirmInput" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white mb-6 focus:ring-2 focus:ring-red-500 focus:outline-none" placeholder="Type RESET to confirm">
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelResetBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Cancel</button>
                    <button type="button" id="confirmResetBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition opacity-50 cursor-not-allowed" disabled>Confirm Reset</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings & Accounts Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content overflow-y-auto">
            <div class="p-6 sm:p-8">
                <h2 class="text-2xl font-bold text-white mb-6">Settings & Accounts</h2>
                
                <!-- General Settings -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-indigo-400 mb-4 border-b border-gray-700 pb-2">General Settings</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="setting-currency" class="block text-sm font-medium text-gray-300 mb-1">Currency Symbol</label>
                            <input type="text" id="setting-currency" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="$">
                        </div>
                         <div>
                            <label for="setting-commission" class="block text-sm font-medium text-gray-300 mb-1">Default Commission</label>
                            <input type="number" step="0.01" id="setting-commission" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0.65">
                        </div>
                    </div>
                </div>

                <!-- Starting Balance -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-indigo-400 mb-4 border-b border-gray-700 pb-2">Starting Balance</h3>
                    <p class="text-xs text-gray-500 mb-3">Set the initial deposit for the currently active account (<strong id="settings-active-account-name" class="text-white"></strong>).</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <input type="number" id="startingBalance" step="100" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="10000">
                        <input type="date" id="startingBalanceDate" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <button id="saveStartingBalance" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition w-full mt-2">Save Balance</button>
                </div>

                <!-- Account Management -->
                 <div class="mb-8">
                    <h3 class="text-lg font-semibold text-indigo-400 mb-4 border-b border-gray-700 pb-2">Manage Accounts</h3>
                    <div id="accounts-list-manager" class="space-y-3 mb-6">
                        <!-- Account manager list will be injected here -->
                    </div>
                    <div class="flex items-center gap-4">
                        <input type="text" id="newAccountName" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="New account name...">
                        <button id="addAccountBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition whitespace-nowrap disabled:bg-indigo-800 disabled:cursor-not-allowed">Add Account</button>
                    </div>
                    <p id="account-limit-msg" class="text-xs text-gray-500 mt-2 text-right hidden">Maximum of 5 accounts.</p>
                </div>

                <!-- Sync Account -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-indigo-400 mb-4 border-b border-gray-700 pb-2">Sync Across Devices</h3>
                    <p class="text-sm text-gray-400 mb-3">To sync data, copy your current Account ID and use the "Link Device" option on your other device.</p>
                    
                    <label for="currentAccountId" class="block text-sm font-medium text-gray-300 mb-1">Your Current Account ID</label>
                    <div class="flex items-center gap-2 mb-4">
                        <input type="text" id="currentAccountId" readonly class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-400 focus:outline-none">
                        <button id="copyAccountIdBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg transition">Copy</button>
                    </div>

                    <label for="linkAccountIdInput" class="block text-sm font-medium text-gray-300 mb-1">Enter an existing Account ID to link this device</label>
                    <div class="flex items-center gap-4">
                        <input type="text" id="linkAccountIdInput" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Paste Account ID here...">
                        <button id="linkDeviceBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition whitespace-nowrap">Link Device</button>
                    </div>
                </div>


                <!-- Sample Data -->
                <div id="sample-data-wrapper" class="mt-8">
                     <h3 class="text-lg font-semibold text-indigo-400 mb-4 border-b border-gray-700 pb-2">Sample Data</h3>
                     <p class="text-sm text-gray-400 mb-3">Your current account is empty. You can load a sample set of trades to explore the dashboard's features.</p>
                     <button id="loadSampleDataBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition w-full">Load Sample Data</button>
                </div>


                 <div class="flex justify-end mt-8">
                    <button type="button" id="closeSettingsBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let auth;
        let db;
        let dataUserId = null; // This will hold the persistent user ID for data storage
        let appDataUnsubscribe = null; // To store the listener unsubscribe function
        let isAuthReady = false;
        let hasInitialized = false; // Flag to prevent re-initialization on listener events

        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
             const isCanvasEnvironment = typeof __firebase_config !== 'undefined' && __firebase_config !== '{}';
            
             const firebaseConfig = isCanvasEnvironment
                ? JSON.parse(__firebase_config)
                : {
                     apiKey: "AIzaSyBz1r3idn-lJlPzol1V3QfBz_28iJvzbpg",
                     authDomain: "options-odssey.firebaseapp.com",
                     projectId: "options-odssey",
                     storageBucket: "options-odssey.firebasestorage.app",
                     messagingSenderId: "684769306457",
                     appId: "1:684769306457:web:fa3beccbfd031decaf4e48",
                     measurementId: "G-2FLCF4T2JQ"
                  };
            
            const initialAuthToken = isCanvasEnvironment ? (typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null) : null;

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); // For detailed logs in console
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.body.innerHTML = '<div class="text-center p-8 text-red-400">Failed to initialize the application. Please check the console.</div>';
                return;
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    console.log("User authenticated with UID:", user.uid);
                    isAuthReady = true;

                    // NEW LOGIC: Use a persistent ID from local storage for data,
                    // or create one from the auth UID if it's the first time on this device.
                    let storedUserId = localStorage.getItem('optionsOdysseyUserId');
                    if (storedUserId) {
                        console.log("Found existing User ID in local storage:", storedUserId);
                        dataUserId = storedUserId;
                    } else {
                        console.log("No User ID in local storage. Creating new one from auth UID.");
                        dataUserId = user.uid; // Use the anonymous UID for a new device
                        localStorage.setItem('optionsOdysseyUserId', dataUserId);
                    }

                    if (appDataUnsubscribe) {
                        appDataUnsubscribe();
                    }
                    setupRealtimeListener(dataUserId);
                } else {
                    console.log("User is signed out.");
                    dataUserId = null;
                    isAuthReady = false;
                    if (appDataUnsubscribe) {
                        appDataUnsubscribe();
                    }
                }
            });

            // Sign in the user
            try {
                 if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase sign-in failed:", error);
            }
        }

        function setupRealtimeListener(userId) {
            if (!userId) return;
            dataUserId = userId; // Ensure global variable is set

            const isCanvasEnvironment = typeof __app_id !== 'undefined';
            // Sanitize app_id to remove invalid characters for Firestore paths
            const appId = isCanvasEnvironment ? __app_id.replace(/\//g, '_') : 'local-dev';

            const docRef = isCanvasEnvironment
                ? doc(db, 'artifacts', appId, 'users', userId, 'data', 'main')
                : doc(db, 'options-odyssey-users', userId);

            appDataUnsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Data exists in Firestore, load it
                    console.log("Firestore data received.");
                    const firestoreData = docSnap.data();
                    window.appData = { ...window.appData, ...firestoreData };
                    if (!window.appData.settings) window.appData.settings = {};
                    window.appData.settings = {
                        currency: '$', 
                        defaultCommission: 0.65,
                        equityTimeFilter: 'all',
                        pnlChartType: 'line', // Add default for bar chart toggle
                        ...window.appData.settings
                    };
                    hasInitialized = true; // Mark as initialized with data
                    window.updateDashboard(); 
                } else if (!hasInitialized) {
                    hasInitialized = true; // Set flag immediately to prevent re-entry
                    // No data in Firestore. Check for local data to migrate.
                    console.log("No document in Firestore. Checking for local data to migrate.");
                    const localData = localStorage.getItem('optionsOdysseyData');
                    if (localData) {
                        console.log("Found local storage data. Migrating to Firestore.");
                        try {
                            const parsedLocalData = JSON.parse(localData);
                            window.appData = parsedLocalData;
                            // Save this data to Firestore, which will trigger this listener again.
                            saveState().then(() => {
                                // Once migration is confirmed, remove local data.
                                localStorage.removeItem('optionsOdysseyData');
                            });
                        } catch(e) {
                             console.error("Failed to parse local data, initializing fresh state.", e);
                             initializeAppState();
                             saveState(); // Save the fresh state
                        }
                    } else {
                        // No Firestore data and no local data.
                        // Initialize a fresh state and save it to create the document.
                        console.log("No data found. Initializing a fresh state in Firestore.");
                        initializeAppState();
                        saveState(); // This will also trigger the listener again.
                    }
                }
            }, (error) => {
                console.error("Firestore snapshot listener error:", error);
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            dayjs.extend(window.dayjs_plugin_quarterOfYear);
            dayjs.extend(window.dayjs_plugin_weekOfYear);

            // Define a global appData object to be accessible by Firebase functions
            window.appData = {};
            
            // --- STATE & CONFIG ---
            const MAX_ACCOUNTS = 5;
            let tradeTableFilter = 'all';
            let equityTimeFilter = 'all';
            let logSearchFilter = '';
            let calendarDate = dayjs();
            let calendarView = 'month';
            let currentPage = 1;
            const itemsPerPage = 10;
            let mainView = 'calendar'; // 'calendar', 'strategy', or 'analytics'
            let sortBy = 'date';
            let sortDirection = 'desc';
            let selectedCalendarDate = null;
            let chartFilter = { type: null, value: null, displayValue: null };

            // --- CHART INSTANCES ---
            let pnlCurveChart;
            let pnlByStrategyChart;
            let pnlByTickerChart;
            let pnlByTagChart;
            let pnlByDayChart;
            let pnlDistributionChart;

            // --- DOM ELEMENTS ---
            const modal = document.getElementById('tradeModal');
            const addTradeBtn = document.getElementById('addTradeBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const tradeForm = document.getElementById('tradeForm');
            const tradeTypeSelect = document.getElementById('trade_type');
            const strikeContainer = document.getElementById('strike-price-container');
            const tradesBody = document.getElementById('recent-trades-body');
            const tradeFilters = document.getElementById('trade-filters');
            const equityCurveFilterSelect = document.getElementById('equity-curve-filter-select');
            
            // Transaction Modal Elements
            const transactionModal = document.getElementById('transactionModal');
            const addTransactionBtn = document.getElementById('addTransactionBtn');
            const cancelTransactionBtn = document.getElementById('cancelTransactionBtn');
            const transactionForm = document.getElementById('transactionForm');

            // Account Balance Elements (now in settings)
            const startingBalanceInput = document.getElementById('startingBalance');
            const startingBalanceDateInput = document.getElementById('startingBalanceDate');
            const saveStartingBalanceBtn = document.getElementById('saveStartingBalance');
            const totalAccountValueEl = document.getElementById('total-account-value');
            const totalDepositsEl = document.getElementById('total-deposits');
            const totalWithdrawalsEl = document.getElementById('total-withdrawals');

            // --- IMPORT MODAL ELEMENTS (NEW) ---
            const importModal = document.getElementById('importModal');
            const importTradesBtn = document.getElementById('importTradesBtn');
            const cancelImportBtn = document.getElementById('cancelImportBtn');
            const csvFileInput = document.getElementById('csvFileInput');
            const fileNameSpan = document.getElementById('fileName');
            const importStep1 = document.getElementById('import-step-1');
            const importStep2 = document.getElementById('import-step-2');
            const importStep3 = document.getElementById('import-step-3');
            const importNextBtn1 = document.getElementById('import-next-btn-1');
            const importBackBtn2 = document.getElementById('import-back-btn-2');
            const importNextBtn2 = document.getElementById('import-next-btn-2');
            const importBackBtn3 = document.getElementById('import-back-btn-3');
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            const columnMappingArea = document.getElementById('column-mapping-area');
            const importPreviewHeader = document.getElementById('import-preview-header');
            const importPreviewBody = document.getElementById('import-preview-body');
            const importSummary = document.getElementById('import-summary');

            // --- Import State Variables ---
            let csvFileContent = null;
            let csvHeaders = [];
            let csvDataRows = [];
            let columnMapping = {};
            let parsedTradesForPreview = [];


            // New Elements
            const logSearchInput = document.getElementById('logSearch');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            // Removed autoCalcRiskBtn reference
            // const autoCalcRiskBtn = document.getElementById('autoCalcRiskBtn');
            const activityLogFooter = document.getElementById('activity-log-footer');
            const paginationControls = document.getElementById('pagination-controls');
            const expiredCheckbox = document.getElementById('expired_worthless');
            const separateCommissionsCheckbox = document.getElementById('separate_commissions');
            const singleCommissionContainer = document.getElementById('single_commission_container');
            const separateCommissionsContainer = document.getElementById('separate_commissions_container');
            const customDateFilterWrapper = document.getElementById('custom-date-filter-wrapper');
            const customStartDateInput = document.getElementById('custom-start-date');
            const customEndDateInput = document.getElementById('custom-end-date');
            const activityLogHeader = document.getElementById('activity-log-header');
            const chartFilterDisplay = document.getElementById('chart-filter-display');
            const clearChartFilterBtn = document.getElementById('clear-chart-filter');
            const pnlChartToggle = document.getElementById('pnl-chart-toggle');
            
            // Main View Toggle Elements
            const mainViewToggle = document.getElementById('main-view-toggle');
            const calendarViewEl = document.getElementById('calendar-view');
            const strategyViewEl = document.getElementById('strategy-view');
            const analyticsViewEl = document.getElementById('analytics-view');
            const mainViewTitle = document.getElementById('main-view-title');
            const calendarControlsWrapper = document.getElementById('calendar-controls-wrapper');

            // Calendar Elements
            const calendarGrid = document.getElementById('calendar-grid');
            const calendarPeriodLabel = document.getElementById('calendar-period-label');
            const prevPeriodBtn = document.getElementById('prev-period');
            const nextPeriodBtn = document.getElementById('next-period');
            const calendarMonthWeekToggle = document.getElementById('calendar-view-toggle-buttons');
            const calendarSummary = document.getElementById('calendar-summary');
            const calendarFilterInfo = document.getElementById('calendar-filter-info');
            const filteredDaySpan = document.getElementById('filtered-day-span');
            const unfilterDayBtn = document.getElementById('unfilter-day-btn');
            
            // Reset Modal Elements
            const resetDataBtn = document.getElementById('resetDataBtn');
            const resetModal = document.getElementById('resetModal');
            const cancelResetBtn = document.getElementById('cancelResetBtn');
            const confirmResetBtn = document.getElementById('confirmResetBtn');
            const resetConfirmInput = document.getElementById('resetConfirmInput');
            
            // Settings & Accounts Elements
            const settingsModal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settings-btn');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const addAccountBtn = document.getElementById('addAccountBtn');
            const accountSwitcherEl = document.getElementById('account-switcher');
            const accountListManagerEl = document.getElementById('accounts-list-manager');
            const currencySettingInput = document.getElementById('setting-currency');
            const commissionSettingInput = document.getElementById('setting-commission');
            const sampleDataWrapper = document.getElementById('sample-data-wrapper');
            const loadSampleDataBtn = document.getElementById('loadSampleDataBtn');
            const currentAccountIdInput = document.getElementById('currentAccountId');
            const copyAccountIdBtn = document.getElementById('copyAccountIdBtn');
            const linkAccountIdInput = document.getElementById('linkAccountIdInput');
            const linkDeviceBtn = document.getElementById('linkDeviceBtn');


            // --- DATA PERSISTENCE & HELPERS ---
            window.saveState = async function() {
                if (!isAuthReady || !dataUserId) {
                    console.warn("Authentication not ready. Cannot save state.");
                    return;
                }
                const isCanvasEnvironment = typeof __app_id !== 'undefined';
                const appId = isCanvasEnvironment ? __app_id.replace(/\//g, '_') : 'local-dev';
                const docRef = isCanvasEnvironment
                    ? doc(db, 'artifacts', appId, 'users', dataUserId, 'data', 'main')
                    : doc(db, 'options-odyssey-users', dataUserId);
                try {
                    // Use setDoc to overwrite the document with the current app state
                    await setDoc(docRef, window.appData, { merge: true });
                    console.log("State saved to Firestore.");
                } catch (error) {
                    console.error("Error saving state to Firestore:", error);
                }
            }

            window.initializeAppState = function() {
                const defaultAccountId = `acc_${Date.now()}`;
                window.appData = {
                    accounts: [{ id: defaultAccountId, name: 'Account 1' }],
                    activeAccountId: defaultAccountId,
                    transactions: { [defaultAccountId]: [] },
                    settings: { 
                        currency: '$', 
                        defaultCommission: 0.65,
                        equityTimeFilter: 'all',
                        pnlChartType: 'line' // Default P&L chart
                    }
                };
            }
            
            function getActiveTransactions() {
                return window.appData.transactions && window.appData.activeAccountId ? window.appData.transactions[window.appData.activeAccountId] || [] : [];
            }
            
            function getActiveAccount() {
                return window.appData.accounts ? window.appData.accounts.find(acc => acc.id === window.appData.activeAccountId) : null;
            }

            function getCurrency() {
                return window.appData.settings ? window.appData.settings.currency || '$' : '$';
            }
            
            function formatCurrency(value) {
                if (typeof value !== 'number') return `${getCurrency()}0.00`;
                
                // Handle floating point inaccuracies around zero
                if (Math.abs(value) < 0.001) {
                    value = 0;
                }

                // Handle -0 specifically after potential rounding
                if (Object.is(value, -0)) {
                    value = 0;
                }
                
                return value.toLocaleString('en-US', { style: 'currency', currency: 'USD', currencyDisplay: 'narrowSymbol' }).replace('$', getCurrency());
            }

            // --- INITIALIZATION ---
            function initialize() {
                // Firebase initialization is now the entry point.
                // updateDashboard will be called by the realtime listener.
                console.log("DOM content loaded. Initializing Firebase...");
            }
            
            function flashButton(button, text, colorClass, duration = 2000) {
                const originalContent = button.innerHTML;
                button.textContent = text;
                button.classList.add(colorClass);
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove(colorClass);
                }, duration);
            }

            // --- ACCOUNT & SETTINGS LOGIC ---
            function renderAccountSwitcher() {
                accountSwitcherEl.innerHTML = '';
                 if (!window.appData.accounts) return;
                window.appData.accounts.forEach(account => {
                    const isActive = account.id === window.appData.activeAccountId;
                    const button = document.createElement('button');
                    button.textContent = account.name;
                    button.dataset.id = account.id;
                    button.className = `account-switch-btn py-2 px-4 rounded-lg text-sm font-semibold transition ${
                        isActive 
                        ? 'bg-indigo-600 text-white shadow-md' 
                        : 'bg-gray-700 hover:bg-gray-600 text-gray-300'
                    }`;
                    button.addEventListener('click', () => {
                        window.appData.activeAccountId = account.id;
                        saveState();
                        updateDashboard();
                    });
                    accountSwitcherEl.appendChild(button);
                });
            }

            function renderSettingsModal() {
                 if (!window.appData.settings) {
                     window.appData.settings = { currency: '$', defaultCommission: 0.65 };
                 }
                // Populate general settings
                currencySettingInput.value = window.appData.settings.currency || '$';
                commissionSettingInput.value = window.appData.settings.defaultCommission || 0;

                // Populate active account name for starting balance section
                const activeAccount = getActiveAccount();
                if (activeAccount) {
                    document.getElementById('settings-active-account-name').textContent = activeAccount.name;
                }

                // Populate starting balance fields
                const allTransactions = getActiveTransactions(); // Ensure this runs before the toggle below
                const initialDeposit = allTransactions.find(t => t.isInitial);
                if (initialDeposit) {
                    startingBalanceInput.value = initialDeposit.amount;
                    startingBalanceDateInput.value = initialDeposit.date;
                } else {
                    startingBalanceInput.value = '';
                    startingBalanceDateInput.value = '';
                }

                // Show/Hide Sample Data Button - Check if allTransactions is available
                // Ensure allTransactions is an array before checking length
                const hasTransactions = Array.isArray(allTransactions) && allTransactions.length > 0;
                sampleDataWrapper.classList.toggle('hidden', hasTransactions);


                // Populate account manager
                accountListManagerEl.innerHTML = '';
                 if (!window.appData.accounts) return;
                window.appData.accounts.forEach(account => {
                    const isActivatable = account.id !== window.appData.activeAccountId && window.appData.accounts.length > 1;
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    div.innerHTML = `
                        <input type="text" value="${account.name}" data-id="${account.id}" class="account-name-input w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <button class="delete-account-btn p-2 text-gray-400 hover:text-red-500 transition disabled:opacity-50 disabled:hover:text-gray-400" data-id="${account.id}" ${!isActivatable ? 'disabled' : ''} title="${!isActivatable ? 'Cannot delete the active account' : 'Delete account'}">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    `;
                    accountListManagerEl.appendChild(div);
                });

                // Check account limit
                const atLimit = window.appData.accounts.length >= MAX_ACCOUNTS;
                addAccountBtn.disabled = atLimit;
                document.getElementById('account-limit-msg').classList.toggle('hidden', !atLimit);
            }

            // --- ACCOUNT BALANCE LOGIC ---
            saveStartingBalanceBtn.addEventListener('click', () => {
                const newBalance = parseFloat(startingBalanceInput.value);
                const newDate = startingBalanceDateInput.value;

                if (isNaN(newBalance) || !newDate) {
                    flashButton(saveStartingBalanceBtn, 'Invalid!', 'bg-red-500');
                    return;
                }
                
                const allTransactions = getActiveTransactions();
                // Date Validation
                const trades = allTransactions.filter(t => t.transaction_type === 'trade');
                if (trades.length > 0) {
                    const firstTradeDate = trades.map(t => dayjs(t.open)).sort((a,b) => a - b)[0];
                    if (dayjs(newDate).isAfter(firstTradeDate)) {
                        flashButton(saveStartingBalanceBtn, 'Date After First Trade!', 'bg-red-500', 3000);
                        return;
                    }
                }
                
                let initialDeposit = allTransactions.find(t => t.isInitial);
                if (initialDeposit) {
                    initialDeposit.amount = newBalance;
                    initialDeposit.date = newDate;
                } else {
                    const newId = allTransactions.length > 0 ? Math.max(...allTransactions.map(t => t.id)) + 1 : 0;
                    allTransactions.unshift({ // Add to the beginning
                        id: newId,
                        transaction_type: 'deposit',
                        amount: newBalance,
                        date: newDate,
                        notes: 'Initial Deposit',
                        isInitial: true
                    });
                }

                window.appData.transactions[window.appData.activeAccountId] = allTransactions;
                saveState();
                updateDashboard();
                flashButton(saveStartingBalanceBtn, 'Saved!', 'bg-green-500');
            });

            // --- MODAL & FORM LOGIC ---
            function resetAndHideModal(modalElement) {
                if(!modalElement) return;
                modalElement.classList.add('hidden');
                const form = modalElement.querySelector('form');
                if (form) form.reset();

                if (modalElement.id === 'tradeModal') {
                    document.getElementById('trade_id').value = '';
                    document.getElementById('modal-title').textContent = 'Log New Trade';
                    document.getElementById('saveBtn').textContent = 'Save Trade';
                    const exitPriceInput = document.getElementById('exit_price');
                    exitPriceInput.disabled = false;
                    exitPriceInput.classList.remove('bg-gray-600');
                    expiredCheckbox.checked = false;
                    separateCommissionsCheckbox.checked = false;
                    singleCommissionContainer.classList.remove('hidden');
                    separateCommissionsContainer.classList.add('hidden');
                    document.getElementById('closing_commission').disabled = false;
                    document.getElementById('closing_commission').classList.remove('bg-gray-600');
                    // Set default commission from settings
                    document.getElementById('commissions').value = window.appData.settings.defaultCommission || 0;

                    // Reset trade type to default and update strikes for the default
                    tradeTypeSelect.value = 'Long Call'; // Reset to default
                    updateStrikeInputs(); // Ensure strikes for default are shown

                } else if (modalElement.id === 'importModal') {
                    // Reset import modal to step 1
                    importStep1.classList.remove('hidden');
                    importStep2.classList.add('hidden');
                    importStep3.classList.add('hidden');
                    
                    fileNameSpan.textContent = 'No file selected';
                    csvFileInput.value = '';
                    importNextBtn1.disabled = true;
                    
                    // Clear state variables
                    csvFileContent = null;
                    csvHeaders = [];
                    csvDataRows = [];
                    columnMapping = {};
                    parsedTradesForPreview = [];

                } else if (modalElement.id === 'resetModal') {
                    resetConfirmInput.value = '';
                    confirmResetBtn.disabled = true;
                    confirmResetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
            
            // Trade Modal Listeners
            addTradeBtn.addEventListener('click', () => {
                // Reset to default selection first
                tradeTypeSelect.value = 'Long Call';
                // Then update strike inputs based on the default
                updateStrikeInputs();
                // Then show modal
                modal.classList.remove('hidden');
                // Pre-fill default commission when opening for a new trade
                document.getElementById('commissions').value = window.appData.settings.defaultCommission || 0;
                 // Ensure quantity validation listener is attached
                attachQuantityValidation();
            });
            cancelBtn.addEventListener('click', () => resetAndHideModal(modal));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) resetAndHideModal(modal);
            });
            
            // Transaction Modal Listeners
            addTransactionBtn.addEventListener('click', () => transactionModal.classList.remove('hidden'));
            cancelTransactionBtn.addEventListener('click', () => resetAndHideModal(transactionModal));
            transactionModal.addEventListener('click', (e) => {
                if (e.target === transactionModal) resetAndHideModal(transactionModal);
            });


            // Import Modal Listeners
            importTradesBtn.addEventListener('click', () => importModal.classList.remove('hidden'));
            cancelImportBtn.addEventListener('click', () => resetAndHideModal(importModal));
            
            // Reset Modal Listeners
            resetDataBtn.addEventListener('click', () => {
                const activeAccount = getActiveAccount();
                if (activeAccount) {
                    document.getElementById('reset-account-name').textContent = activeAccount.name;
                    resetModal.classList.remove('hidden');
                }
            });
            cancelResetBtn.addEventListener('click', () => resetAndHideModal(resetModal));
            resetModal.addEventListener('click', (e) => {
                if (e.target === resetModal) resetAndHideModal(resetModal);
            });
            resetConfirmInput.addEventListener('input', (e) => {
                if (e.target.value === 'RESET') {
                    confirmResetBtn.disabled = false;
                    confirmResetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    confirmResetBtn.disabled = true;
                    confirmResetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
            confirmResetBtn.addEventListener('click', () => {
                window.appData.transactions[window.appData.activeAccountId] = [];
                saveState();
                currentPage = 1;
                logSearchFilter = '';
                logSearchInput.value = '';
                resetAndHideModal(resetModal);
                updateDashboard();
            });
            
            // Settings Modal Listeners
            settingsBtn.addEventListener('click', () => {
                if (dataUserId) {
                    currentAccountIdInput.value = dataUserId;
                }
                renderSettingsModal();
                settingsModal.classList.remove('hidden');
            });
            closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) settingsModal.classList.add('hidden');
            });

            copyAccountIdBtn.addEventListener('click', () => {
                currentAccountIdInput.select();
                document.execCommand('copy');
                flashButton(copyAccountIdBtn, 'Copied!', 'bg-green-500');
            });

            linkDeviceBtn.addEventListener('click', () => {
                const newId = linkAccountIdInput.value.trim();
                if (newId) {
                    localStorage.setItem('optionsOdysseyUserId', newId);
                    linkDeviceBtn.textContent = "Linked! Reloading...";
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            });

            // Settings Event Delegation
            settingsModal.addEventListener('change', (e) => {
                let settingsChanged = false;
                 if (e.target.id === 'setting-currency') {
                      window.appData.settings.currency = e.target.value || '$';
                      settingsChanged = true;
                 }
                 if (e.target.id === 'setting-commission') {
                      window.appData.settings.defaultCommission = parseFloat(e.target.value) || 0;
                      settingsChanged = true;
                 }
                 if(settingsChanged) {
                      saveState();
                      updateDashboard(); // Re-render to apply currency/commission changes
                 }
            });

            accountListManagerEl.addEventListener('change', (e) => {
                if (e.target.classList.contains('account-name-input')) {
                    const accountId = e.target.dataset.id;
                    const account = window.appData.accounts.find(acc => acc.id === accountId);
                    if (account) {
                        account.name = e.target.value;
                        saveState();
                        renderAccountSwitcher(); // Update tabs immediately
                        renderSettingsModal(); // Update active account name in settings
                    }
                }
            });

            accountListManagerEl.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-account-btn');
                if (deleteBtn) {
                    const accountId = deleteBtn.dataset.id;
                    // Double check it's not the active one
                    if (accountId === window.appData.activeAccountId || window.appData.accounts.length <= 1) return;
                    
                    const deletedWasActive = accountId === window.appData.activeAccountId;
                    
                    window.appData.accounts = window.appData.accounts.filter(acc => acc.id !== accountId);
                    delete window.appData.transactions[accountId];

                    // If the deleted account was the active one, switch to the first remaining account
                    if (deletedWasActive) {
                        window.appData.activeAccountId = window.appData.accounts[0].id;
                    }
                    
                    saveState();
                    renderSettingsModal(); // Re-render the list inside the modal
                    renderAccountSwitcher(); // Re-render the top tabs
                    updateDashboard(); // Refresh dashboard with new active account
                }
            });

             addAccountBtn.addEventListener('click', () => {
                if (window.appData.accounts.length >= MAX_ACCOUNTS) return;
                const newName = document.getElementById('newAccountName').value.trim();
                if (newName) {
                    const newAccountId = `acc_${Date.now()}`;
                    window.appData.accounts.push({ id: newAccountId, name: newName });
                    window.appData.transactions[newAccountId] = [];
                    document.getElementById('newAccountName').value = '';
                    saveState();
                    renderSettingsModal();
                    renderAccountSwitcher();
                }
            });

            loadSampleDataBtn.addEventListener('click', () => {
                window.appData.transactions[window.appData.activeAccountId] = generateDummyData();
                saveState();
                updateDashboard();
                renderSettingsModal(); // Re-render modal to hide the button
                flashButton(loadSampleDataBtn, 'Data Loaded!', 'bg-green-500');
            });
            
            separateCommissionsCheckbox.addEventListener('change', () => {
                singleCommissionContainer.classList.toggle('hidden', separateCommissionsCheckbox.checked);
                separateCommissionsContainer.classList.toggle('hidden', !separateCommissionsCheckbox.checked);
                if (separateCommissionsCheckbox.checked) {
                    document.getElementById('opening_commission').value = window.appData.settings.defaultCommission || 0;
                }
            });


            expiredCheckbox.addEventListener('change', () => {
                const exitPriceInput = document.getElementById('exit_price');
                const closingCommInput = document.getElementById('closing_commission');
                const type = tradeTypeSelect.value;
                const details = strategyDetails[type];
                const exitPrice2Input = document.getElementById('exit_price_2');

                if (expiredCheckbox.checked) {
                    exitPriceInput.value = 0;
                    exitPriceInput.disabled = true;
                    exitPriceInput.classList.add('bg-gray-600');
                    
                    if (details.ratio) {
                        exitPrice2Input.value = 0;
                        exitPrice2Input.disabled = true;
                        exitPrice2Input.classList.add('bg-gray-600');
                    }

                    if (!separateCommissionsCheckbox.checked) {
                        separateCommissionsCheckbox.click(); // This forces separate commissions
                    }
                    document.getElementById('opening_commission').value = window.appData.settings.defaultCommission || 0;
                    closingCommInput.value = 0;
                    closingCommInput.disabled = true;
                    closingCommInput.classList.add('bg-gray-600');

                } else {
                    exitPriceInput.disabled = false;
                    exitPriceInput.classList.remove('bg-gray-600');
                    if (details.ratio) {
                        exitPrice2Input.disabled = false;
                        exitPrice2Input.classList.remove('bg-gray-600');
                    }
                    closingCommInput.disabled = false;
                    closingCommInput.classList.remove('bg-gray-600');

                    // Revert commission setting
                    if (separateCommissionsCheckbox.checked) {
                        separateCommissionsCheckbox.click();
                    }
                }
            });

            const strategyDetails = {
                'Long Call': { strikes: ['Strike'], risk: 'debit' },
                'Long Put': { strikes: ['Strike'], risk: 'debit' },
                'Short Call': { strikes: ['Strike'], risk: 'undefined' },
                'Short Put': { strikes: ['Strike'], risk: 'collateral' },
                'Long Call Spread': { strikes: ['Long Strike', 'Short Strike'], risk: 'debit' },
                'Long Put Spread': { strikes: ['Short Strike', 'Long Strike'], risk: 'debit' },
                'Short Call Spread': { strikes: ['Short Strike', 'Long Strike'], risk: 'spread' },
                'Short Put Spread': { strikes: ['Short Strike', 'Long Strike'], risk: 'spread' },
                'Calendar Spread': { strikes: ['Strike'], risk: 'debit', expirations: 2 },
                'Long Ratio Spread': { strikes: ['Long Strike', 'Short Strike'], ratio: true, risk: 'custom' },
                'Short Ratio Spread': { strikes: ['Short Strike', 'Long Strike'], ratio: true, risk: 'custom' },
                'Long Straddle': { strikes: ['Strike'], risk: 'debit' },
                'Short Straddle': { strikes: ['Strike'], risk: 'undefined' },
                'Long Strangle': { strikes: ['Put Strike', 'Call Strike'], risk: 'debit' },
                'Short Strangle': { strikes: ['Put Strike', 'Call Strike'], risk: 'undefined' },
                'Long Butterfly': { strikes: ['Low Strike', 'Mid Strike', 'High Strike'], risk: 'debit' },
                'Short Butterfly': { strikes: ['Low Strike', 'Mid Strike', 'High Strike'], risk: 'credit' },
                'Short Iron Condor': { strikes: ['Long Put', 'Short Put', 'Short Call', 'Long Call'], risk: 'spread' },
                'Short Iron Butterfly': { strikes: ['Long Put', 'Short Strike', 'Long Call'], risk: 'spread' }
            };

            function updateStrikeInputs() {
                const type = tradeTypeSelect.value;
                const details = strategyDetails[type] || { strikes: ['Strike'], risk: 'undefined' };
                const maxRiskInput = document.getElementById('max_risk');
                const ratioContainer = document.getElementById('ratio-inputs-container');
                const leg1Title = document.getElementById('leg_1_title');
                const exp2Container = document.getElementById('expiration_date_2_container');
                
                strikeContainer.innerHTML = '';
                details.strikes.forEach((label, i) => {
                    strikeContainer.innerHTML += `
                        <div>
                            <label for="strike_price_${i}" class="block text-sm font-medium text-gray-300 mb-1">${label}</label>
                            <input type="number" step="0.01" id="strike_price_${i}" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="150.00">
                        </div>
                    `;
                });
                
                // Handle complex strategies visibility
                const isRatio = details.ratio === true;
                const isCalendar = details.expirations === 2;
                ratioContainer.classList.toggle('hidden', !isRatio);
                exp2Container.classList.toggle('hidden', !isCalendar);
                leg1Title.textContent = isRatio ? 'Leg 1 Financials' : 'Financials';
                document.getElementById('expiration_date_2').required = isCalendar;
                document.getElementById('quantity_2').required = isRatio;
                document.getElementById('entry_price_2').required = isRatio;
                document.getElementById('exit_price_2').required = isRatio;

                if (details.risk === 'undefined' || details.risk === 'custom') {
                    maxRiskInput.required = false;
                    maxRiskInput.placeholder = 'Collateral (Optional)';
                } else {
                    maxRiskInput.required = true;
                    maxRiskInput.placeholder = '500';
                }

                 // Attach listeners to new strike inputs for auto-calc AFTER they are created
                strikeContainer.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', updateAutoCalculatedRisk);
                });
                 // Ensure quantity validation listener is attached
                attachQuantityValidation();
                
                // Trigger calculation after inputs are updated and listeners attached
                updateAutoCalculatedRisk();
            }

            tradeTypeSelect.addEventListener('change', updateStrikeInputs);
            // updateStrikeInputs(); // Initial setup is now handled by addTradeBtn click

            // Add listeners to other relevant fields for auto-calculation
            document.getElementById('quantity').addEventListener('input', updateAutoCalculatedRisk);
            document.getElementById('entry_price').addEventListener('input', updateAutoCalculatedRisk);

             // --- Validation for Quantity Inputs ---
            function enforceIntegerInput(event) {
                const input = event.target;
                if (input.value.includes('.')) {
                    input.value = Math.round(parseFloat(input.value));
                }
            }

            function attachQuantityValidation() {
                 const qtyInput = document.getElementById('quantity');
                 const qty2Input = document.getElementById('quantity_2');
                 if (qtyInput) qtyInput.addEventListener('input', enforceIntegerInput);
                 if (qty2Input) qty2Input.addEventListener('input', enforceIntegerInput);
            }
            // --- End Quantity Validation ---


            // --- Auto-calculate Max Risk Function ---
            function updateAutoCalculatedRisk() {
                // console.log("[AutoRisk] updateAutoCalculatedRisk triggered");
                if (!strikeContainer) {
                    // console.log("[AutoRisk] strikeContainer not found");
                    return;
                }

                const type = tradeTypeSelect.value;
                const details = strategyDetails[type];
                const maxRiskInput = document.getElementById('max_risk');
                const riskTypesWithAutoCalc = ['spread', 'debit', 'collateral'];

                if (!details || !riskTypesWithAutoCalc.includes(details.risk)) {
                    // console.log("[AutoRisk] Not an auto-calculable risk type or no details");
                    return;
                }

                const strikes = Array.from(strikeContainer.querySelectorAll('input')).map(input => parseFloat(input.value));
                const quantity = parseInt(document.getElementById('quantity').value);
                const entryPriceValue = parseFloat(document.getElementById('entry_price').value); // Renamed variable

                // console.log("[AutoRisk] Read values:", { type, quantity, entryPrice: entryPriceValue, strikes });

                // --- Refined Validation ---
                let inputsValid = true;
                if (isNaN(quantity) || quantity <= 0) {
                    // console.log("[AutoRisk] Invalid quantity");
                    inputsValid = false;
                }
                if (isNaN(entryPriceValue)) {
                    // console.log("[AutoRisk] Invalid entryPrice");
                    inputsValid = false;
                }
                if (strikes.length !== details.strikes.length || strikes.some(isNaN)) {
                    // console.log("[AutoRisk] Invalid or incomplete strikes", strikes, "Expected:", details.strikes.length);
                    inputsValid = false;
                }
                // --- End Refined Validation ---

                if (!inputsValid) {
                    // console.log("[AutoRisk] Inputs invalid, returning.");
                    return;
                }

                // Pass the correctly named variable
                const tempTrade = { type, strikes, quantity, entry_price: entryPriceValue }; 
                const calculatedRisk = calculateMaxRisk(tempTrade);

                // console.log("[AutoRisk] Calculated risk:", calculatedRisk);

                if (!isNaN(calculatedRisk)) {
                    maxRiskInput.value = Math.round(calculatedRisk);
                } else {
                    // console.warn("[AutoRisk] Calculated risk was NaN for:", tempTrade);
                }
            }


            function calculateMaxRisk(trade) {
                 const details = strategyDetails[trade.type];
                 const { strikes, quantity, entry_price } = trade;
                 let calculatedRisk = 0;
                 if (!details) return 0;

                 // **Add explicit NaN checks for safety**
                 if (isNaN(quantity) || quantity <= 0 || isNaN(entry_price)) {
                     console.error("[calculateMaxRisk] Invalid quantity or entry_price received:", trade);
                     return NaN; // Return NaN explicitly
                 }


                 if (details.risk === 'debit') {
                    calculatedRisk = entry_price * 100 * quantity;
                 } else if (details.risk === 'spread' && strikes.length >= 2) {
                     // **Add NaN check for strikes here too**
                     if (strikes.some(isNaN)) {
                         console.error("[calculateMaxRisk] Invalid strikes received for spread:", trade);
                         return NaN;
                     }
                     const width = Math.abs(strikes[0] - strikes[1]);
                     calculatedRisk = width * 100 * quantity;
                     if (trade.type.includes('Short')) { // Credit spread
                         const creditReceived = entry_price * 100 * quantity;
                         calculatedRisk -= creditReceived;
                     }
                 } else if (details.risk === 'collateral' && strikes.length === 1) {
                     // **Add NaN check for strike**
                     if (isNaN(strikes[0])) {
                         console.error("[calculateMaxRisk] Invalid strike received for collateral:", trade);
                         return NaN;
                     }
                    const collateral = (strikes[0] * 100 * quantity) - (entry_price * 100 * quantity);
                    calculatedRisk = collateral > 0 ? collateral : 0;
                 }

                 // **Check final result before returning**
                 return !isNaN(calculatedRisk) ? Math.round(calculatedRisk) : 0; // Return 0 if somehow still NaN
            }

            function calculateRawPnl(trade) {
                const multiplier = 100;
                
                // Define credit strategies (those not in the debit list)
                const debitStrategies = ['Long Call', 'Long Put', 'Long Call Spread', 'Long Put Spread', 'Long Straddle', 'Long Strangle', 'Long Butterfly', 'Calendar Spread'];
                const isCreditStrategy = !debitStrategies.includes(trade.type);

                // Handle expired credit strategies explicitly for clarity and robustness
                if (trade.isExpired && isCreditStrategy) {
                    if (trade.ratio) {
                        // For Short Ratio, credit from short leg, debit from long leg
                        const credit = trade.entry_price * trade.quantity * multiplier;
                        const debit = trade.entry_price_2 * trade.quantity_2 * multiplier;
                        return trade.type === 'Short Ratio Spread' ? credit - debit : debit - credit;
                    }
                    return trade.entry_price * trade.quantity * multiplier;
                }

                // Handle Ratio Spreads
                if (trade.ratio) {
                    let pnl1 = 0;
                    let pnl2 = 0;

                    if (trade.type === 'Long Ratio Spread') {
                        // Leg 1 is long, Leg 2 is short
                        pnl1 = (trade.exit_price - trade.entry_price) * trade.quantity * multiplier;
                        pnl2 = (trade.entry_price_2 - trade.exit_price_2) * trade.quantity_2 * multiplier;
                    } else { // Short Ratio Spread
                        // Leg 1 is short, Leg 2 is long
                        pnl1 = (trade.entry_price - trade.exit_price) * trade.quantity * multiplier;
                        pnl2 = (trade.exit_price_2 - trade.entry_price_2) * trade.quantity_2 * multiplier;
                    }
                    return pnl1 + pnl2;
                }

                // Handle Standard Spreads
                const { entry_price, exit_price, quantity, type } = trade;
                let pnl = 0;
                if (debitStrategies.includes(type)) {
                    pnl = (exit_price - entry_price) * quantity * multiplier;
                } 
                else {
                    pnl = (entry_price - exit_price) * quantity * multiplier;
                }
                return pnl;
            }

            function getTradeCommissions(trade) {
                const { commissions, opening_commission, closing_commission, quantity, quantity_2, isExpired, ratio } = trade;

                if (opening_commission != null && closing_commission != null) {
                    const totalQuantity = ratio ? quantity + quantity_2 : quantity;
                    return (opening_commission + closing_commission) * totalQuantity;
                } else if (commissions != null) {
                     // For single commission, assume it's per leg per side.
                    if (isExpired) { // Only opening commission
                        return ratio ? (commissions * quantity) + (commissions * quantity_2) : (commissions * quantity);
                    } else { // Opening and closing
                         return ratio ? (commissions * quantity * 2) + (commissions * quantity_2 * 2) : (commissions * quantity * 2);
                    }
                }
                return 0; // No commission info provided
            }


            function calculatePnl(trade) {
                const rawPnl = calculateRawPnl(trade);
                const totalCommissions = getTradeCommissions(trade);
                return rawPnl - totalCommissions;
            }
            
            transactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                 const allTransactions = getActiveTransactions();
                const transactionData = {
                    id: allTransactions.length > 0 ? Math.max(...allTransactions.map(t => t.id)) + 1 : 0,
                    transaction_type: document.getElementById('transaction_type').value,
                    amount: parseFloat(document.getElementById('transaction_amount').value),
                    date: document.getElementById('transaction_date').value,
                    notes: document.getElementById('transaction_notes').value,
                    isInitial: false
                };
                allTransactions.push(transactionData);
                window.appData.transactions[window.appData.activeAccountId] = allTransactions;
                saveState();
                updateDashboard();
                resetAndHideModal(transactionModal);
            });

            tradeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('saveBtn');
                const openDate = document.getElementById('open_date').value;
                const closeDate = document.getElementById('close_date').value;
                
                const openDay = dayjs(openDate).day();
                const closeDay = dayjs(closeDate).day();

                if (openDay === 0 || openDay === 6 || closeDay === 0 || closeDay === 6) {
                    flashButton(saveBtn, 'Weekend dates are not allowed!', 'bg-red-500', 3000);
                    return;
                }

                const allTransactions = getActiveTransactions();
                const tradeId = document.getElementById('trade_id').value;
                
                const initialDeposit = allTransactions.find(t => t.isInitial);

                // Date validation
                if (initialDeposit && dayjs(openDate).isBefore(dayjs(initialDeposit.date))) {
                    flashButton(saveBtn, 'Trade Before Start Date!', 'bg-red-500', 3000);
                    return;
                }

                const type = document.getElementById('trade_type').value;
                const details = strategyDetails[type];

                // **Use parseInt for quantities**
                const quantityValue = parseInt(document.getElementById('quantity').value);
                const quantity2Value = details.ratio === true ? parseInt(document.getElementById('quantity_2').value) : null;

                // Basic validation for parsed quantities
                if (isNaN(quantityValue) || quantityValue <= 0 || (details.ratio === true && (isNaN(quantity2Value) || quantity2Value <= 0)) ) {
                     flashButton(saveBtn, 'Invalid Quantity!', 'bg-red-500', 3000);
                     return;
                }

                const tradeData = {
                    transaction_type: 'trade',
                    ticker: document.getElementById('underlying_ticker').value.toUpperCase(),
                    type: type,
                    open: openDate,
                    close: closeDate,
                    expiration: document.getElementById('expiration_date').value,
                    expiration_2: details.expirations === 2 ? document.getElementById('expiration_date_2').value : null,
                    strikes: Array.from(strikeContainer.querySelectorAll('input')).map(input => parseFloat(input.value)),
                    quantity: quantityValue, // Use parsed integer
                    entry_price: parseFloat(document.getElementById('entry_price').value),
                    exit_price: parseFloat(document.getElementById('exit_price').value),
                    commissions: parseFloat(document.getElementById('commissions').value),
                    opening_commission: separateCommissionsCheckbox.checked ? parseFloat(document.getElementById('opening_commission').value) : null,
                    closing_commission: separateCommissionsCheckbox.checked ? parseFloat(document.getElementById('closing_commission').value) : null,
                    max_risk: parseFloat(document.getElementById('max_risk').value) || 0,
                    tags: document.getElementById('tags').value,
                    notes: document.getElementById('notes').value,
                    isExpired: expiredCheckbox.checked,
                    ratio: details.ratio === true,
                    quantity_2: quantity2Value, // Use parsed integer
                    entry_price_2: details.ratio === true ? parseFloat(document.getElementById('entry_price_2').value) : null,
                    exit_price_2: details.ratio === true ? parseFloat(document.getElementById('exit_price_2').value) : null,
                };
                
                tradeData.pnl = parseFloat(calculatePnl(tradeData).toFixed(2));

                if (tradeId) {
                    const index = allTransactions.findIndex(t => t.id == tradeId);
                    if (index !== -1) {
                        allTransactions[index] = { ...allTransactions[index], ...tradeData };
                    }
                } else {
                    tradeData.id = allTransactions.length > 0 ? Math.max(...allTransactions.map(t => t.id)) + 1 : 0;
                    allTransactions.push(tradeData);
                }
                window.appData.transactions[window.appData.activeAccountId] = allTransactions;
                saveState();
                updateDashboard();
                resetAndHideModal(modal);
            });

            function populateFormForEdit(tradeId) {
                const allTransactions = getActiveTransactions();
                const item = allTransactions.find(t => t.id === tradeId);
                if (!item || item.transaction_type !== 'trade') return;

                document.getElementById('modal-title').textContent = 'Edit Trade';
                document.getElementById('saveBtn').textContent = 'Update Trade';
                document.getElementById('trade_id').value = item.id;
                document.getElementById('underlying_ticker').value = item.ticker;
                document.getElementById('trade_type').value = item.type;
                
                document.getElementById('open_date').value = item.open.split('T')[0];
                document.getElementById('close_date').value = item.close.split('T')[0];

                document.getElementById('expiration_date').value = item.expiration;
                if (item.expiration_2) {
                     document.getElementById('expiration_date_2').value = item.expiration_2;
                }

                document.getElementById('quantity').value = item.quantity;
                document.getElementById('entry_price').value = item.entry_price;
                document.getElementById('exit_price').value = item.exit_price;

                if (item.ratio) {
                    document.getElementById('quantity_2').value = item.quantity_2;
                    document.getElementById('entry_price_2').value = item.entry_price_2;
                    document.getElementById('exit_price_2').value = item.exit_price_2;
                }

                document.getElementById('max_risk').value = item.max_risk;
                document.getElementById('tags').value = item.tags;
                document.getElementById('notes').value = item.notes;
                
                if(item.opening_commission != null) {
                    separateCommissionsCheckbox.checked = true;
                    singleCommissionContainer.classList.add('hidden');
                    separateCommissionsContainer.classList.remove('hidden');
                    document.getElementById('opening_commission').value = item.opening_commission;
                    document.getElementById('closing_commission').value = item.closing_commission;
                } else {
                    separateCommissionsCheckbox.checked = false;
                    singleCommissionContainer.classList.remove('hidden');
                    separateCommissionsContainer.classList.add('hidden');
                    document.getElementById('commissions').value = item.commissions;
                }

                updateStrikeInputs();
                item.strikes.forEach((strike, index) => {
                    const strikeInput = document.getElementById(`strike_price_${index}`);
                    if (strikeInput) strikeInput.value = strike;
                });
                
                const exitPriceInput = document.getElementById('exit_price');
                const closingCommInput = document.getElementById('closing_commission');

                if(item.isExpired) {
                    expiredCheckbox.checked = true;
                    exitPriceInput.disabled = true;
                    exitPriceInput.classList.add('bg-gray-600');
                    closingCommInput.disabled = true;
                    closingCommInput.classList.add('bg-gray-600');
                } else {
                    expiredCheckbox.checked = false;
                    exitPriceInput.disabled = false;
                    exitPriceInput.classList.remove('bg-gray-600');
                    closingCommInput.disabled = false;
                    closingCommInput.classList.remove('bg-gray-600');
                }

                modal.classList.remove('hidden');
                // Ensure quantity validation listener is attached when editing
                attachQuantityValidation();
            }
            
            // --- NEW INTERACTIVE IMPORT LOGIC ---
            
            // Step 1: File selection
            csvFileInput.addEventListener('change', () => {
                const file = csvFileInput.files[0];
                if (!file) {
                    fileNameSpan.textContent = 'No file selected';
                    importNextBtn1.disabled = true;
                    return;
                };

                fileNameSpan.textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(event) {
                    csvFileContent = event.target.result;
                    const lines = csvFileContent.split(/[\r\n]+/).filter(line => line.trim() !== '');
                    if (lines.length < 2) {
                        // Handle error: not enough data
                        console.error("CSV must have a header and at least one data row.");
                        importNextBtn1.disabled = true;
                        return;
                    }
                    // Simple CSV header parsing (doesn't handle quotes in headers)
                    csvHeaders = lines[0].split(',').map(h => h.trim());
                    csvDataRows = lines.slice(1).map(line => line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, '')));

                    importNextBtn1.disabled = false;
                };
                reader.readAsText(file);
            });

            // Step 1 -> 2
            importNextBtn1.addEventListener('click', () => {
                renderColumnMappingUI();
                importStep1.classList.add('hidden');
                importStep2.classList.remove('hidden');
            });

            // Step 2 <- 1
            importBackBtn2.addEventListener('click', () => {
                importStep2.classList.add('hidden');
                importStep1.classList.remove('hidden');
            });

            // Step 2 -> 3
            importNextBtn2.addEventListener('click', () => {
                // Save the user's mapping
                columnMapping = {};
                document.querySelectorAll('.column-map-select').forEach(select => {
                    if (select.value) { // Only map if a value is selected
                       columnMapping[select.dataset.field] = select.value;
                    }
                });
                renderImportPreviewUI();
                importStep2.classList.add('hidden');
                importStep3.classList.remove('hidden');
            });

            // Step 3 <- 2
            importBackBtn3.addEventListener('click', () => {
                importStep3.classList.add('hidden');
                importStep2.classList.remove('hidden');
            });

            // Step 3: Final Import
            confirmImportBtn.addEventListener('click', () => {
                const validTrades = parsedTradesForPreview.filter(t => t.isValid);
                if (validTrades.length === 0) return;

                const allTransactions = getActiveTransactions();
                const startingId = allTransactions.length > 0 ? Math.max(...allTransactions.map(t => t.id)) + 1 : 0;

                const newTransactions = validTrades.map((trade, index) => {
                    return { ...trade.data, id: startingId + index };
                });
                
                window.appData.transactions[window.appData.activeAccountId] = [...allTransactions, ...newTransactions];
                saveState();
                updateDashboard();
                resetAndHideModal(importModal);
            });

            function renderColumnMappingUI() {
                const appFields = [
                    { key: 'Ticker', required: true, synonyms: ['ticker', 'symbol', 'stock'] },
                    { key: 'TradeType', required: true, synonyms: ['tradetype', 'strategy', 'type'] },
                    { key: 'OpenDate', required: true, synonyms: ['opendate', 'open date', 'opened'] },
                    { key: 'CloseDate', required: true, synonyms: ['closedate', 'close date', 'closed'] },
                    { key: 'ExpirationDate', required: true, synonyms: ['expirationdate', 'expiration', 'exp'] },
                    { key: 'Strikes', required: true, synonyms: ['strikes', 'strike'] },
                    { key: 'Quantity', required: true, synonyms: ['quantity', 'qty'] },
                    { key: 'EntryPrice', required: true, synonyms: ['entryprice', 'entry price', 'entry'] },
                    { key: 'ExitPrice', required: true, synonyms: ['exitprice', 'exit price', 'exit'] },
                    { key: 'Expired', required: false, synonyms: ['expired', 'expired worthless'] },
                    { key: 'CommissionsPerContract', required: false, synonyms: ['commissionspercontract', 'commissions', 'comm'] },
                    { key: 'OpeningCommission', required: false, synonyms: ['openingcommission', 'open comm'] },
                    { key: 'ClosingCommission', required: false, synonyms: ['closingcommission', 'close comm'] },
                    { key: 'MaxRisk', required: false, synonyms: ['maxrisk', 'risk', 'collateral'] },
                    { key: 'Tags', required: false, synonyms: ['tags', 'tag'] },
                    { key: 'Notes', required: false, synonyms: ['notes', 'note'] },
                    { key: 'ExpirationDate2', required: false, synonyms: ['expirationdate2', 'exp2'] },
                    { key: 'Quantity2', required: false, synonyms: ['quantity2', 'qty2'] },
                    { key: 'EntryPrice2', required: false, synonyms: ['entryprice2', 'entry2'] },
                    { key: 'ExitPrice2', required: false, synonyms: ['exitprice2', 'exit2'] },
                ];

                columnMappingArea.innerHTML = '';

                appFields.forEach(field => {
                    const row = document.createElement('div');
                    row.className = 'flex flex-col';

                    const label = document.createElement('label');
                    label.htmlFor = `map-${field.key}`;
                    label.className = 'text-sm font-medium text-gray-300 mb-1';
                    label.innerHTML = `${field.key} ${field.required ? '<span class="text-red-400">*</span>' : ''}`;
                    
                    const select = document.createElement('select');
                    select.id = `map-${field.key}`;
                    select.dataset.field = field.key;
                    select.className = 'column-map-select w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none';

                    // Add default empty option
                    select.innerHTML = `<option value="">- Skip this field -</option>`;
                    
                    // Add options from CSV headers
                    csvHeaders.forEach(header => {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        select.appendChild(option);
                    });
                    
                    // Auto-select based on synonyms
                    const lowerCaseHeaders = csvHeaders.map(h => h.toLowerCase());
                    for (const synonym of field.synonyms) {
                        const matchIndex = lowerCaseHeaders.indexOf(synonym);
                        if (matchIndex > -1) {
                            select.value = csvHeaders[matchIndex];
                            break;
                        }
                    }

                    row.appendChild(label);
                    row.appendChild(select);
                    columnMappingArea.appendChild(row);
                });
            }

            function renderImportPreviewUI() {
                parsedTradesForPreview = [];
                importPreviewHeader.innerHTML = '';
                importPreviewBody.innerHTML = '';

                // Create header row from mapped fields
                const mappedHeaders = ['Status', ...Object.values(columnMapping)];
                importPreviewHeader.innerHTML = mappedHeaders.map(h => `<th class="p-2 font-semibold border-b border-gray-600">${h}</th>`).join('');

                const headerToIndexMap = csvHeaders.reduce((acc, header, index) => {
                    acc[header] = index;
                    return acc;
                }, {});


                csvDataRows.forEach((row, rowIndex) => {
                    const tradeObj = {};
                    let validationError = null;
                    
                    try {
                        // Use mapping to build a raw object
                        const rawData = {};
                        for (const [appField, csvHeader] of Object.entries(columnMapping)) {
                             const colIndex = headerToIndexMap[csvHeader];
                             if(colIndex !== undefined) {
                                rawData[appField] = row[colIndex];
                             }
                        }

                        // Validate required fields
                        const requiredFields = ['Ticker', 'TradeType', 'OpenDate', 'CloseDate', 'ExpirationDate', 'Strikes', 'Quantity', 'EntryPrice', 'ExitPrice'];
                        const missingField = requiredFields.find(f => !rawData[f]);
                        if (missingField) {
                            throw new Error(`Missing required field: ${missingField}`);
                        }

                        // --- SMART PARSING & NORMALIZATION ---
                        const type = normalizeTradeType(rawData.TradeType);
                        if (!type) {
                            throw new Error(`Unrecognized TradeType: ${rawData.TradeType}`);
                        }
                        const details = strategyDetails[type];
                        
                        const openDate = dayjs(rawData.OpenDate);
                        const closeDate = dayjs(rawData.CloseDate);
                        if (!openDate.isValid() || !closeDate.isValid()) {
                            throw new Error(`Invalid date format.`);
                        }

                        const tradeData = {
                            transaction_type: 'trade',
                            ticker: rawData.Ticker.toUpperCase(),
                            type: type,
                            open: openDate.format('YYYY-MM-DD'),
                            close: closeDate.format('YYYY-MM-DD'),
                            expiration: dayjs(rawData.ExpirationDate).format('YYYY-MM-DD'),
                            strikes: (rawData.Strikes || '').split(/[,/ ]+/).map(s => parseFloat(s.trim())).filter(s => !isNaN(s)),
                            quantity: parseInt(rawData.Quantity),
                            entry_price: parseFloat(rawData.EntryPrice),
                            exit_price: parseFloat(rawData.ExitPrice),
                            isExpired: (rawData.Expired || '').toUpperCase() === 'TRUE',
                            // Optional fields
                            tags: rawData.Tags || '',
                            notes: rawData.Notes || '',
                            // Complex strategies
                            ratio: details.ratio === true,
                            expiration_2: (details.expirations === 2 && rawData.ExpirationDate2) ? dayjs(rawData.ExpirationDate2).format('YYYY-MM-DD') : null,
                            quantity_2: (details.ratio === true && rawData.Quantity2) ? parseInt(rawData.Quantity2) : null,
                            entry_price_2: (details.ratio === true && rawData.EntryPrice2) ? parseFloat(rawData.EntryPrice2) : null,
                            exit_price_2: (details.ratio === true && rawData.ExitPrice2) ? parseFloat(rawData.ExitPrice2) : null,
                        };

                        // Smart Exit Price for expired
                        if (tradeData.isExpired) {
                            tradeData.exit_price = 0;
                            if (tradeData.exit_price_2) tradeData.exit_price_2 = 0;
                        }

                        // Commission Logic
                        if (rawData.OpeningCommission && rawData.ClosingCommission) {
                            tradeData.opening_commission = parseFloat(rawData.OpeningCommission) || 0;
                            tradeData.closing_commission = parseFloat(rawData.ClosingCommission) || 0;
                        } else {
                            tradeData.commissions = parseFloat(rawData.CommissionsPerContract) || (appData.settings.defaultCommission || 0);
                        }
                        
                        // Smart Risk Calculation
                        tradeData.max_risk = parseFloat(rawData.MaxRisk) || 0;
                        if (tradeData.max_risk === 0) {
                            tradeData.max_risk = calculateMaxRisk(tradeData);
                        }

                        tradeData.pnl = calculatePnl(tradeData);
                        parsedTradesForPreview.push({ isValid: true, data: tradeData });

                    } catch (e) {
                         validationError = e.message;
                         parsedTradesForPreview.push({ isValid: false, error: validationError, raw: row });
                    }
                    
                    const tr = document.createElement('tr');
                    tr.className = validationError ? 'bg-red-900/50' : 'bg-green-900/30';
                    let rowHtml = `<td class="p-2 border-b border-gray-700">${validationError ? `<span class="text-red-400 font-semibold" title="${validationError}">Error</span>` : '<span class="text-green-400">OK</span>'}</td>`;
                    
                    for (const header of Object.values(columnMapping)) {
                        const colIndex = headerToIndexMap[header];
                        const cellValue = row[colIndex] || '';
                        rowHtml += `<td class="p-2 border-b border-gray-700 truncate" title="${cellValue}">${cellValue}</td>`;
                    }
                    
                    tr.innerHTML = rowHtml;
                    importPreviewBody.appendChild(tr);
                });
                
                // Update summary and confirm button
                const validCount = parsedTradesForPreview.filter(t => t.isValid).length;
                importSummary.textContent = `${validCount} of ${csvDataRows.length} trades are valid and will be imported.`;
                confirmImportBtn.disabled = validCount === 0;
                confirmImportBtn.classList.toggle('opacity-50', validCount === 0);
                confirmImportBtn.classList.toggle('cursor-not-allowed', validCount === 0);
            }

            function normalizeTradeType(rawType) {
                const type = rawType.toLowerCase().replace(/[\s-]/g, '');
                
                // Handle simple calls/puts, assume long
                if (type === 'call') return 'Long Call';
                if (type === 'put') return 'Long Put';
                
                // Simple Long/Short
                if (type.includes('longcall') || type === 'lc') return 'Long Call';
                if (type.includes('longput') || type === 'lp') return 'Long Put';
                if (type.includes('shortcall') || type === 'sc') return 'Short Call';
                if (type.includes('shortput') || type === 'sp') return 'Short Put';
                
                // Spreads
                if (type.includes('longcallspread') || type.includes('debitcall') || type.includes('callspread')) return 'Long Call Spread';
                if (type.includes('longputspread') || type.includes('debitput') || type.includes('putspread')) return 'Long Put Spread';
                if (type.includes('shortcallspread') || type.includes('creditcall') || type.includes('bearcall')) return 'Short Call Spread';
                if (type.includes('shortputspread') || type.includes('creditput') || type.includes('bullput')) return 'Short Put Spread';

                // Complex
                if (type.includes('ironcondor')) return 'Short Iron Condor';
                if (type.includes('ironbutterfly') || type.includes('ironfly')) return 'Short Iron Butterfly';
                if (type.includes('straddle')) return type.includes('short') ? 'Short Straddle' : 'Long Straddle';
                if (type.includes('strangle')) return type.includes('short') ? 'Short Strangle' : 'Long Strangle';
                if (type.includes('butterfly') || type.includes('fly')) return type.includes('short') ? 'Short Butterfly' : 'Long Butterfly';
                if (type.includes('calendar')) return 'Calendar Spread';
                if (type.includes('ratio')) return type.includes('short') ? 'Short Ratio Spread' : 'Long Ratio Spread';
                
                return null; // Not found
            }
            
            function calculateMaxRisk(trade) {
                 const details = strategyDetails[trade.type];
                 const { strikes, quantity, entry_price } = trade;
                 let calculatedRisk = 0;
                 if (!details) return 0;

                 // **Add explicit NaN checks for safety**
                 if (isNaN(quantity) || quantity <= 0 || isNaN(entry_price)) {
                     console.error("[calculateMaxRisk] Invalid quantity or entry_price received:", trade);
                     return NaN; // Return NaN explicitly
                 }


                 if (details.risk === 'debit') {
                    calculatedRisk = entry_price * 100 * quantity;
                 } else if (details.risk === 'spread' && strikes.length >= 2) {
                     // **Add NaN check for strikes here too**
                     if (strikes.some(isNaN)) {
                         console.error("[calculateMaxRisk] Invalid strikes received for spread:", trade);
                         return NaN;
                     }
                     const width = Math.abs(strikes[0] - strikes[1]);
                     calculatedRisk = width * 100 * quantity;
                     if (trade.type.includes('Short')) { // Credit spread
                         const creditReceived = entry_price * 100 * quantity;
                         calculatedRisk -= creditReceived;
                     }
                 } else if (details.risk === 'collateral' && strikes.length === 1) {
                     // **Add NaN check for strike**
                     if (isNaN(strikes[0])) {
                         console.error("[calculateMaxRisk] Invalid strike received for collateral:", trade);
                         return NaN;
                     }
                    const collateral = (strikes[0] * 100 * quantity) - (entry_price * 100 * quantity);
                    calculatedRisk = collateral > 0 ? collateral : 0;
                 }

                 // **Check final result before returning**
                 return !isNaN(calculatedRisk) ? Math.round(calculatedRisk) : 0; // Return 0 if somehow still NaN
            }

            // --- TABLE & CHART EVENT LISTENERS ---
            pnlChartToggle.addEventListener('click', (e) => {
                const btn = e.target.closest('.pnl-chart-btn');
                if (btn) {
                    const newType = btn.dataset.chartType;
                    if (window.appData.settings.pnlChartType !== newType) {
                        window.appData.settings.pnlChartType = newType;
                        saveState();
                        updateDashboard();
                    }
                }
            });

            activityLogHeader.addEventListener('click', (e) => {
                const sortBtn = e.target.closest('.sort-btn');
                if (sortBtn) {
                    const newSortBy = sortBtn.dataset.sort;
                    if (sortBy === newSortBy) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortBy = newSortBy;
                        sortDirection = 'desc';
                    }
                    currentPage = 1; // Reset to page 1 on new sort
                    updateDashboard();
                }
            });

            tradesBody.addEventListener('click', (e) => {
                const allTransactions = getActiveTransactions();
                const editButton = e.target.closest('.edit-btn');
                const deleteButton = e.target.closest('.delete-btn');
                const tradeRow = e.target.closest('tr[data-id]');
                const tagButton = e.target.closest('.tag-filter');

                if (tagButton) {
                    logSearchInput.value = tagButton.dataset.tag;
                    logSearchFilter = tagButton.dataset.tag.toLowerCase();
                    updateDashboard();
                    return;
                }

                if (editButton) {
                    const itemId = parseInt(editButton.dataset.id);
                    populateFormForEdit(itemId);
                    return;
                }

                if (deleteButton) {
                    const itemId = parseInt(deleteButton.dataset.id);
                    const itemToDelete = allTransactions.find(t => t.id === itemId);
                    if (itemToDelete && itemToDelete.isInitial) {
                        // Don't let initial deposit be deleted from here, must be done via the settings
                         return;
                    }
                    window.appData.transactions[window.appData.activeAccountId] = allTransactions.filter(t => t.id !== itemId);
                    saveState();
                    updateDashboard();
                    return;
                }

                if (tradeRow) {
                    const itemId = parseInt(tradeRow.dataset.id);
                    const item = allTransactions.find(t => t.id === itemId);
                    const nextRow = tradeRow.nextElementSibling;

                    if (nextRow && nextRow.classList.contains('details-row')) {
                        nextRow.remove();
                    } else if (item && item.transaction_type === 'trade') {
                        const detailsRow = document.createElement('tr');
                        detailsRow.className = 'details-row bg-gray-800';
                        const numCols = activityLogHeader.querySelectorAll('th:not(.hidden)').length;

                        const totalCommissions = getTradeCommissions(item);
                        let content = `<td colspan="${numCols}" class="p-0">`;

                        if (item.ratio) {
                            // Custom layout for Ratio Spreads
                            const rocValue = item.max_risk > 0 ? ((calculateRawPnl(item) / item.max_risk) * 100).toFixed(2) + '%' : 'N/A';
                            const rocColor = rocValue === 'N/A' ? 'text-gray-300' : parseFloat(rocValue) >= 0 ? 'text-green-400' : 'text-red-400';

                            content += `
                                <div class="p-4">
                                     <div class="flex flex-col text-sm mb-4">
                                         <span class="text-xs text-gray-500">Open / Close Dates</span>
                                         <span class="font-semibold text-gray-300">${dayjs(item.open).format('YYYY-MM-DD')} to ${dayjs(item.close).format('YYYY-MM-DD')}</span>
                                     </div>
                                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                         <!-- Leg 1 -->
                                         <div>
                                             <h5 class="text-sm font-semibold text-indigo-400 mb-2">Leg 1: ${item.strikes[0]}</h5>
                                             <div class="space-y-2 text-sm text-gray-400">
                                                 <div class="flex justify-between"><span>Quantity:</span> <span class="font-semibold text-gray-300">${item.quantity}</span></div>
                                                 <div class="flex justify-between"><span>Entry / Exit:</span> <span class="font-semibold text-gray-300">${formatCurrency(item.entry_price)} / ${formatCurrency(item.exit_price)}</span></div>
                                             </div>
                                         </div>
                                         <!-- Leg 2 -->
                                         <div>
                                             <h5 class="text-sm font-semibold text-indigo-400 mb-2">Leg 2: ${item.strikes[1]}</h5>
                                             <div class="space-y-2 text-sm text-gray-400">
                                                 <div class="flex justify-between"><span>Quantity:</span> <span class="font-semibold text-gray-300">${item.quantity_2}</span></div>
                                                 <div class="flex justify-between"><span>Entry / Exit:</span> <span class="font-semibold text-gray-300">${formatCurrency(item.entry_price_2)} / ${formatCurrency(item.exit_price_2)}</span></div>
                                             </div>
                                         </div>
                                     </div>
                                     <div class="border-t border-gray-700/50 mt-4 pt-4 grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                                         <div class="flex flex-col">
                                             <span class="text-xs text-gray-500">Commissions</span>
                                             <span class="font-semibold text-gray-300">${formatCurrency(totalCommissions)}</span>
                                         </div>
                                         <div class="flex flex-col">
                                             <span class="text-xs text-gray-500">Max Risk</span>
                                             <span class="font-semibold text-gray-300">${formatCurrency(item.max_risk)}</span>
                                         </div>
                                         <div class="flex flex-col">
                                             <span class="text-xs text-gray-500">Return on Capital</span>
                                             <span class="font-semibold ${rocColor}">${rocValue}</span>
                                         </div>
                                     </div>
                                </div>
                            `;

                        } else {
                            // Original layout for all other trades
                            const rocValue = item.max_risk > 0 ? ((calculateRawPnl(item) / item.max_risk) * 100).toFixed(2) + '%' : 'N/A';
                            const rocColor = rocValue === 'N/A' ? 'text-gray-300' : parseFloat(rocValue) >= 0 ? 'text-green-400' : 'text-red-400';
                            content += `
                            <div class="p-4">
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-6 gap-y-4 text-gray-400 text-sm">
                                     <div class="flex flex-col sm:col-span-2">
                                         <span class="text-xs text-gray-500">Open / Close Dates</span>
                                         <span class="font-semibold text-gray-300">${dayjs(item.open).format('YYYY-MM-DD')} to ${dayjs(item.close).format('YYYY-MM-DD')}</span>
                                     </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray-500">Strikes</span>
                                        <span class="font-semibold text-gray-300">${item.strikes.join(' / ')}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray-500">Quantity</span>
                                        <span class="font-semibold text-gray-300">${item.quantity}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray-500">Entry / Exit</span>
                                        <span class="font-semibold text-gray-300">${formatCurrency(item.entry_price)} / ${formatCurrency(item.exit_price)}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray-500">Commissions</span>
                                        <span class="font-semibold text-gray-300">${formatCurrency(totalCommissions)}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray-500">Max Risk</span>
                                        <span class="font-semibold text-gray-300">${formatCurrency(item.max_risk)}</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-gray-500">Return on Capital</span>
                                        <span class="font-semibold ${rocColor}">${rocValue}</span>
                                    </div>
                                </div>
                            </div>
                            `;
                            
                            // Calendar Spread Details
                            if(item.expiration_2) {
                                content += `
                                <div class="border-t border-gray-700/50 p-4">
                                    <div class="flex flex-col text-sm">
                                        <span class="text-xs text-gray-500">Expirations</span>
                                        <span class="font-semibold text-gray-300">${dayjs(item.expiration).format('YYYY-MM-DD')} / ${dayjs(item.expiration_2).format('YYYY-MM-DD')}</span>
                                    </div>
                                </div>
                            `;
                            }
                        }

                        // Notes and Tags Section (common for both layouts)
                        if (item.notes || item.tags) {
                            content += `<div class="border-t border-gray-700/50 p-4 space-y-3">`;
                            if (item.notes) {
                                content += `
                                    <div>
                                        <strong class="text-gray-300 text-sm">Notes:</strong>
                                        <p class="text-gray-400 text-sm whitespace-pre-wrap font-mono">${item.notes}</p>
                                    </div>
                                `;
                            }
                            if (item.tags) {
                                content += `
                                    <div>
                                        <strong class="text-gray-300 text-sm">Tags:</strong>
                                        <div class="flex flex-wrap gap-2 mt-1">
                                            ${item.tags.split(',').map(t => `<button data-tag="${t.trim()}" class="tag-filter bg-indigo-500/50 hover:bg-indigo-500/80 text-indigo-300 text-xs font-medium px-2.5 py-0.5 rounded-full transition">${t.trim()}</button>`).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                            content += `</div>`;
                        }
                        
                        content += `</td>`;
                        detailsRow.innerHTML = content;
                        
                        tradeRow.insertAdjacentElement('afterend', detailsRow);
                    }
                }
            });

            function clearAllFilters() {
                tradeTableFilter = 'all';
                selectedCalendarDate = null;
                chartFilter = { type: null, value: null, displayValue: null };

                document.querySelectorAll('#trade-filters .filter-btn').forEach(btn => {
                    const isAllButton = btn.dataset.filter === 'all';
                    btn.classList.toggle('bg-indigo-600', isAllButton);
                    btn.classList.toggle('text-white', isAllButton);
                    btn.classList.toggle('bg-gray-700', !isAllButton);
                    btn.classList.toggle('text-gray-300', !isAllButton);
                });
            }

            tradeFilters.addEventListener('click', (e) => {
                const filterButton = e.target.closest('.filter-btn');
                if (!filterButton) return;
                
                // Deactivate all other buttons
                document.querySelectorAll('#trade-filters .filter-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                });

                tradeTableFilter = filterButton.dataset.filter;
                currentPage = 1; 

                // Activate clicked button
                filterButton.classList.add('bg-indigo-600', 'text-white');
                filterButton.classList.remove('bg-gray-700', 'text-gray-300');

                // Clear other filter types
                selectedCalendarDate = null;
                chartFilter = { type: null, value: null, displayValue: null };

                updateDashboard();
            });


            clearChartFilterBtn.addEventListener('click', () => {
                clearAllFilters();
                updateDashboard();
            });


            equityCurveFilterSelect.addEventListener('change', (e) => {
                equityTimeFilter = e.target.value;
                 if (window.appData && window.appData.settings) {
                    window.appData.settings.equityTimeFilter = equityTimeFilter;
                    saveState();
                }
                customDateFilterWrapper.classList.toggle('hidden', equityTimeFilter !== 'custom');
                updateDashboard();
            });

            [customStartDateInput, customEndDateInput].forEach(input => {
                input.addEventListener('change', () => {
                    if (equityTimeFilter === 'custom') {
                        updateDashboard();
                    }
                });
            });
            
            logSearchInput.addEventListener('input', (e) => {
                logSearchFilter = e.target.value.toLowerCase();
                currentPage = 1; // Reset to first page on search
                updateDashboard();
            });
            
            // Removed event listener for the now non-existent autoCalcRiskBtn
            /*
            autoCalcRiskBtn.addEventListener('click', () => {
                const type = tradeTypeSelect.value;
                const details = strategyDetails[type];
                const strikes = Array.from(strikeContainer.querySelectorAll('input')).map(input => parseFloat(input.value));
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                const entryPrice = parseFloat(document.getElementById('entry_price').value) || 0;
                const maxRiskInput = document.getElementById('max_risk');
                
                const tempTrade = { type, strikes, quantity, entry_price };
                maxRiskInput.value = calculateMaxRisk(tempTrade);
            });
            */
            
            mainViewToggle.addEventListener('click', (e) => {
                const btn = e.target.closest('.main-view-btn');
                if (!btn) return;
                mainView = btn.dataset.view;
                updateDashboard();
            });

            function setChartFilter(type, value, displayValue = null) {
                const currentDisplayValue = chartFilter.displayValue || chartFilter.value;
                const newDisplayValue = displayValue || value;

                if (chartFilter.type === type && currentDisplayValue === newDisplayValue) {
                    // If clicking the same thing again, clear the filter
                    clearAllFilters();
                } else {
                    clearAllFilters(); // Clear other filters before setting a new one
                    chartFilter.type = type;
                    chartFilter.value = value;
                    chartFilter.displayValue = displayValue; // Store the pretty display value
                }
                currentPage = 1;
                setTimeout(() => {
                    updateDashboard();
                }, 0);
            }


            // --- DASHBOARD UPDATE LOGIC ---
            let filteredActivityForExport = []; // Variable to hold filtered data for export
            window.updateDashboard = function() {
                if (!isAuthReady || !window.appData) {
                    console.log("Dashboard update skipped: auth not ready or no data.");
                    return;
                }
                
                // --- Restore settings from appData ---
                if (window.appData.settings) {
                    equityTimeFilter = window.appData.settings.equityTimeFilter || 'all';
                    
                    // Update UI elements to reflect the loaded state
                    equityCurveFilterSelect.value = equityTimeFilter;
                    customDateFilterWrapper.classList.toggle('hidden', equityTimeFilter !== 'custom');
                }
                // --- End of restore settings ---

                const getItemDate = (item) => dayjs(item.transaction_type === 'trade' ? item.close : item.date);

                renderAccountSwitcher();
                
                const allTransactions = getActiveTransactions();
                const trades = allTransactions.filter(t => t.transaction_type === 'trade');
                const validTrades = trades.filter(t => ![0, 6].includes(dayjs(t.close).day()));
                
                let currentPeriodTrades = validTrades;
                
                // Determine date ranges for current and previous periods
                let currentStartDate, currentEndDate;

                // Use the REAL current date for time period filters like "This Month", "YTD", etc.
                const referenceDateForFilters = dayjs();
                
                switch (equityTimeFilter) {
                    case 'today':
                        currentStartDate = referenceDateForFilters.clone().startOf('day');
                        currentEndDate = referenceDateForFilters.clone().endOf('day');
                        break;
                    case 'this-week':
                        currentStartDate = referenceDateForFilters.clone().startOf('week');
                        currentEndDate = referenceDateForFilters.clone().endOf('week');
                        break;
                    case 'mtd':
                        currentStartDate = referenceDateForFilters.clone().startOf('month');
                        currentEndDate = referenceDateForFilters.clone().endOf('month');
                        break;
                    case 'qtd':
                        currentStartDate = referenceDateForFilters.clone().startOf('quarter');
                        currentEndDate = referenceDateForFilters.clone().endOf('quarter');
                        break;
                    case 'ytd':
                        currentStartDate = referenceDateForFilters.clone().startOf('year');
                        currentEndDate = referenceDateForFilters.clone().endOf('year');
                        break;
                    case 'custom':
                        const start = dayjs(customStartDateInput.value);
                        const end = dayjs(customEndDateInput.value);
                        if (start.isValid() && end.isValid() && start.isBefore(end)) {
                            currentStartDate = start.startOf('day');
                            currentEndDate = end.endOf('day');
                        }
                        break;
                    case 'all':
                    default:
                        // No date filtering
                        break;
                }
                
                if (equityTimeFilter !== 'all' && currentStartDate && currentEndDate) {
                    currentPeriodTrades = validTrades.filter(t => {
                        const closeDate = dayjs(t.close);
                        return !closeDate.isBefore(currentStartDate, 'day') && !closeDate.isAfter(currentEndDate, 'day');
                    });
                }
                
                // --- KPI Calculations ---
                const calculateKpis = (tradeList) => {
                    const hasTrades = tradeList.length > 0;
                    const totalPnl = hasTrades ? tradeList.reduce((acc, trade) => acc + trade.pnl, 0) : 0;
                    const winningTrades = hasTrades ? tradeList.filter(trade => trade.pnl > 0) : [];
                    const winRate = hasTrades ? (winningTrades.length / tradeList.length) * 100 : 0;
                    const rocTrades = tradeList.filter(t => t.max_risk > 0);
                    const avgRoc = rocTrades.length > 0 ? (rocTrades.reduce((acc, t) => acc + (calculateRawPnl(t) / t.max_risk), 0) / rocTrades.length) * 100 : 0;
                    return { totalPnl, winRate, avgRoc, tradeCount: tradeList.length };
                };

                const currentKpis = calculateKpis(currentPeriodTrades);
                
                // Update KPI cards
                const pnlElement = document.getElementById('kpi-total-pnl');
                pnlElement.textContent = formatCurrency(currentKpis.totalPnl);
                pnlElement.className = `text-2xl sm:text-3xl font-bold mt-1 ${currentKpis.totalPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
                
                document.getElementById('kpi-win-rate').textContent = `${currentKpis.winRate.toFixed(1)}%`;
                document.getElementById('kpi-avg-roc').textContent = `${currentKpis.avgRoc.toFixed(1)}%`;
                document.getElementById('kpi-total-trades').textContent = currentKpis.tradeCount;
                
                // --- ACCOUNT VALUE & OVERALL STATS---
                const allDeposits = allTransactions.filter(t => t.transaction_type === 'deposit');
                const totalDeposits = allDeposits.reduce((acc, t) => acc + t.amount, 0);
                const allWithdrawals = allTransactions.filter(t => t.transaction_type === 'withdrawal');
                const totalWithdrawals = allWithdrawals.reduce((acc, t) => acc + t.amount, 0);

                document.getElementById('total-deposits').textContent = formatCurrency(totalDeposits);
                document.getElementById('total-withdrawals').textContent = formatCurrency(totalWithdrawals);

                const totalPnl = validTrades.reduce((acc, trade) => acc + trade.pnl, 0);
                const totalAccountValue = totalDeposits - totalWithdrawals + totalPnl;
                totalAccountValueEl.textContent = formatCurrency(totalAccountValue);
                
                // --- Performance Stats Card (Dynamic) ---
                document.getElementById('performance-stats-title').textContent = `Performance Stats (${equityCurveFilterSelect.options[equityCurveFilterSelect.selectedIndex].text})`;
                const sortedPeriodTradesForStats = [...currentPeriodTrades].sort((a,b) => new Date(a.close) - new Date(b.close));
                
                const statsWins = sortedPeriodTradesForStats.filter(t => t.pnl > 0);
                const statsLosses = sortedPeriodTradesForStats.filter(t => t.pnl <= 0);
                const statsAvgWin = statsWins.length > 0 ? statsWins.reduce((sum, t) => sum + t.pnl, 0) / statsWins.length : 0;
                const statsAvgLoss = statsLosses.length > 0 ? statsLosses.reduce((sum, t) => sum + t.pnl, 0) / statsLosses.length : 0;
                const statsLargestWin = statsWins.length > 0 ? Math.max(...statsWins.map(t => t.pnl)) : 0;
                const statsLargestLoss = statsLosses.length > 0 ? Math.min(...statsLosses.map(t => t.pnl)) : 0;
                const grossProfit = statsWins.reduce((acc, t) => acc + t.pnl, 0);
                const grossLoss = Math.abs(statsLosses.reduce((acc, t) => acc + t.pnl, 0));
                const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : Infinity;
                const expectancy = sortedPeriodTradesForStats.length > 0 ? currentKpis.totalPnl / sortedPeriodTradesForStats.length : 0;
                const avgHold = sortedPeriodTradesForStats.length > 0 ? sortedPeriodTradesForStats.reduce((acc, t) => acc + dayjs(t.close).diff(dayjs(t.open), 'day'), 0) / sortedPeriodTradesForStats.length : 0;
                const totalCommissions = sortedPeriodTradesForStats.reduce((acc, t) => acc + getTradeCommissions(t), 0);
                
                // Streaks
                let winStreak = 0, lossStreak = 0, maxWinStreak = 0, maxLossStreak = 0;
                sortedPeriodTradesForStats.forEach(trade => {
                    if (trade.pnl > 0) {
                        winStreak++;
                        lossStreak = 0;
                        if (winStreak > maxWinStreak) maxWinStreak = winStreak;
                    } else {
                        lossStreak++;
                        winStreak = 0;
                        if (lossStreak > maxLossStreak) maxLossStreak = lossStreak;
                    }
                });

                // Max Drawdown Calculation
                let peakPnl = 0;
                let maxDrawdown = 0;
                let cumulativePnl = 0;
                sortedPeriodTradesForStats.forEach(trade => {
                    cumulativePnl += trade.pnl;
                    if (cumulativePnl > peakPnl) {
                        peakPnl = cumulativePnl;
                    }
                    const drawdown = peakPnl - cumulativePnl;
                    if (drawdown > maxDrawdown) {
                        maxDrawdown = drawdown;
                    }
                });

                document.getElementById('stats-avg-win').textContent = formatCurrency(statsAvgWin);
                document.getElementById('stats-avg-loss').textContent = formatCurrency(statsAvgLoss);
                document.getElementById('stats-largest-win').textContent = formatCurrency(statsLargestWin);
                document.getElementById('stats-largest-loss').textContent = formatCurrency(statsLargestLoss);
                document.getElementById('stats-profit-factor').textContent = profitFactor === Infinity ? '∞' : profitFactor.toFixed(2);
                document.getElementById('stats-expectancy').textContent = formatCurrency(expectancy);
                document.getElementById('stats-max-drawdown').textContent = `-${formatCurrency(maxDrawdown)}`;
                document.getElementById('stats-avg-hold').textContent = `${avgHold.toFixed(1)} days`;
                document.getElementById('stats-win-streak').textContent = maxWinStreak;
                document.getElementById('stats-loss-streak').textContent = maxLossStreak;
                document.getElementById('stats-total-comm').textContent = formatCurrency(totalCommissions);


                // --- P&L Chart Logic ---
                const pnlChartType = (window.appData.settings && window.appData.settings.pnlChartType) || 'line';
                // Update toggle button UI
                document.querySelectorAll('.pnl-chart-btn').forEach(btn => {
                    const isSelected = btn.dataset.chartType === pnlChartType;
                    btn.classList.toggle('bg-indigo-600', isSelected);
                    btn.classList.toggle('text-white', isSelected);
                    btn.classList.toggle('bg-gray-900/50', !isSelected); // Use the container's bg color for non-selected
                });

                const sortedTrades = [...validTrades].sort((a,b) => new Date(a.close) - new Date(b.close));
                let chartStartDate = null;
                let chartEndDate = referenceDateForFilters.endOf('day');
                
                const accountStartDate = allTransactions.find(t => t.isInitial)?.date;

                if (equityTimeFilter !== 'all' && currentStartDate && currentEndDate) {
                    chartStartDate = currentStartDate;
                    chartEndDate = currentEndDate;
                } else if (accountStartDate) {
                    chartStartDate = dayjs(accountStartDate);
                }
                
                if (accountStartDate && chartStartDate && chartStartDate.isBefore(dayjs(accountStartDate))) {
                    chartStartDate = dayjs(accountStartDate);
                }

                let periodTrades = sortedTrades;
                if (chartStartDate && chartStartDate.isValid()) {
                    periodTrades = sortedTrades.filter(t => {
                        const eventDate = dayjs(t.close);
                        return !eventDate.isBefore(chartStartDate) && !eventDate.isAfter(chartEndDate);
                    });
                }
                
                if (pnlCurveChart) pnlCurveChart.destroy();
                
                if (pnlChartType === 'line') {
                    // --- CUMULATIVE P&L LINE CHART ---
                    let periodStartingPnl = 0;
                    let startingLabel = 'Start';
                    
                    if (chartStartDate && chartStartDate.isValid()) {
                        const priorTrades = sortedTrades.filter(t => dayjs(t.close).isBefore(chartStartDate));
                        periodStartingPnl = priorTrades.reduce((acc, trade) => acc + trade.pnl, 0);
                        startingLabel = chartStartDate.format('MM/DD/YY');
                    }

                    let runningPnl = periodStartingPnl;
                    const pnlData = periodTrades.map(trade => {
                        runningPnl += trade.pnl;
                        return runningPnl;
                    });
                    
                    const pnlLabels = periodTrades.map(t => dayjs(t.close).format('MM/DD/YY'));

                    pnlCurveChart = new Chart(document.getElementById('pnlCurveChart'), {
                        type: 'line',
                        data: {
                            labels: [startingLabel, ...pnlLabels],
                            datasets: [{
                                label: 'Cumulative P&L',
                                data: [periodStartingPnl, ...pnlData],
                                fill: {
                                    target: 'origin',
                                    above: 'rgba(74, 222, 128, 0.2)',
                                    below: 'rgba(248, 113, 113, 0.2)'
                                },
                                tension: 0.3,
                                segment: {
                                    borderColor: ctx => {
                                        if (!ctx.p0 || !ctx.p1) return '#a78bfa'; // Default for start/end
                                        if (ctx.p0.parsed.y >= 0 && ctx.p1.parsed.y >= 0) return 'rgba(74, 222, 128, 1)';
                                        if (ctx.p0.parsed.y < 0 && ctx.p1.parsed.y < 0) return 'rgba(248, 113, 113, 1)';
                                        return '#a78bfa';
                                    }
                                },
                                pointBackgroundColor: ctx => ctx.raw >= 0 ? 'rgba(74, 222, 128, 1)' : 'rgba(248, 113, 113, 1)',
                                pointBorderColor: ctx => ctx.raw >= 0 ? 'rgba(74, 222, 128, 1)' : 'rgba(248, 113, 113, 1)',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: ctx => ctx.raw >= 0 ? 'rgba(74, 222, 128, 1)' : 'rgba(248, 113, 113, 1)'
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            responsive: true,
                            scales: {
                                y: {
                                    ticks: { color: '#9ca3af', callback: function(value) { return formatCurrency(value); } },
                                    grid: { color: 'rgba(75, 85, 99, 0.5)' },
                                    border: { display: false }
                                },
                                x: {
                                    ticks: { color: '#9ca3af' },
                                    grid: { display: false },
                                    border: { display: false }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed.y !== null) { label += formatCurrency(context.parsed.y); }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    // --- DAILY P&L BAR CHART ---
                    const dailyPnl = periodTrades.reduce((acc, trade) => {
                        const closeDate = dayjs(trade.close).format('YYYY-MM-DD');
                        if (!acc[closeDate]) {
                            acc[closeDate] = 0;
                        }
                        acc[closeDate] += trade.pnl;
                        return acc;
                    }, {});

                    const sortedDates = Object.keys(dailyPnl).sort((a, b) => dayjs(a).diff(dayjs(b)));
                    const barLabels = sortedDates.map(date => dayjs(date).format('MM/DD/YY'));
                    const barData = sortedDates.map(date => dailyPnl[date]);
                    const barColors = barData.map(pnl => pnl >= 0 ? 'rgba(74, 222, 128, 0.7)' : 'rgba(248, 113, 113, 0.7)');

                    pnlCurveChart = new Chart(document.getElementById('pnlCurveChart'), {
                        type: 'bar',
                        data: {
                            labels: barLabels,
                            datasets: [{
                                label: 'Daily P&L',
                                data: barData,
                                backgroundColor: barColors
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            responsive: true,
                            scales: {
                                y: {
                                    ticks: { color: '#9ca3af', callback: function(value) { return formatCurrency(value); } },
                                    grid: { color: 'rgba(75, 85, 99, 0.5)', zeroLineColor: '#9ca3af' },
                                    border: { display: false }
                                },
                                x: {
                                    ticks: { color: '#9ca3af' },
                                    grid: { display: false },
                                    border: { display: false }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = 'Daily P&L: ';
                                            if (context.parsed.y !== null) { label += formatCurrency(context.parsed.y); }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }


                // P&L By Strategy Chart is now dynamic
                const strategyPnl = currentPeriodTrades.reduce((acc, trade) => {
                    if (!acc[trade.type]) acc[trade.type] = 0;
                    acc[trade.type] += trade.pnl;
                    return acc;
                }, {});
                if (pnlByStrategyChart) pnlByStrategyChart.destroy();
                pnlByStrategyChart = new Chart(document.getElementById('pnlByStrategyChart'), {
                    type: 'bar', data: {
                        labels: Object.keys(strategyPnl),
                        datasets: [{ label: 'Total P&L', data: Object.values(strategyPnl), backgroundColor: Object.values(strategyPnl).map(pnl => pnl >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'), }]
                    },
                    options: { maintainAspectRatio: false, responsive: true, scales: { y: { ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { display: false } }, 
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const elementIndex = elements[0].index;
                                const clickedLabel = event.chart.data.labels[elementIndex];
                                setChartFilter('strategy', clickedLabel);
                            }
                        },
                    }
                });
                
                // --- Analytics Charts ---
                updateAnalyticsCharts(currentPeriodTrades);

                // --- Main View Toggle Logic ---
                document.querySelectorAll('.main-view-btn').forEach(btn => {
                    if (btn.dataset.view === mainView) {
                        btn.classList.add('bg-indigo-600', 'text-white');
                        btn.classList.remove('bg-gray-700', 'text-gray-300');
                    } else {
                        btn.classList.remove('bg-indigo-600', 'text-white');
                        btn.classList.add('bg-gray-700', 'text-gray-300');
                    }
                });

                calendarViewEl.classList.add('hidden');
                strategyViewEl.classList.add('hidden');
                analyticsViewEl.classList.add('hidden');
                calendarControlsWrapper.classList.add('hidden');

                if (mainView === 'calendar') {
                    calendarViewEl.classList.remove('hidden');
                    mainViewTitle.textContent = 'Trading Calendar';
                    calendarControlsWrapper.classList.remove('hidden');
                } else if (mainView === 'strategy') {
                    strategyViewEl.classList.remove('hidden');
                    mainViewTitle.textContent = `P&L by Strategy (${equityCurveFilterSelect.options[equityCurveFilterSelect.selectedIndex].text})`;
                } else if (mainView === 'analytics') {
                    analyticsViewEl.classList.remove('hidden');
                    mainViewTitle.textContent = `Advanced Analytics (${equityCurveFilterSelect.options[equityCurveFilterSelect.selectedIndex].text})`;
                }

                // Calendar Logic
                renderCalendar();

                // --- Activity Log Filtering ---
                let filteredActivity = allTransactions;
                
                // Show calendar filter status
                if (selectedCalendarDate) {
                     filteredDaySpan.textContent = `Filtered to: ${dayjs(selectedCalendarDate).format('MMM D, YYYY')}`;
                     calendarFilterInfo.classList.remove('hidden');
                } else {
                     calendarFilterInfo.classList.add('hidden');
                }

                // Apply filters in order of precedence: Chart > Calendar > Dropdown
                if (chartFilter.type) {
                    switch (chartFilter.type) {
                        case 'strategy':
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'trade' && t.type === chartFilter.value);
                            break;
                        case 'ticker':
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'trade' && t.ticker === chartFilter.value);
                            break;
                        case 'otherTickers':
                            {
                                const tickersToExclude = chartFilter.value;
                                filteredActivity = allTransactions.filter(t => t.transaction_type === 'trade' && !tickersToExclude.includes(t.ticker));
                            }
                            break;
                        case 'tag':
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'trade' && t.tags && t.tags.split(',').map(tag => tag.trim()).includes(chartFilter.value));
                            break;
                        case 'otherTags':
                             {
                                const tagsToExclude = chartFilter.value;
                                filteredActivity = allTransactions.filter(t => {
                                    // Keep non-trades
                                    if (t.transaction_type !== 'trade') return true; 
                                    // Keep trades with no tags when filtering "other"
                                    if (!t.tags || t.tags.trim() === '') return true; 
                                    
                                    const tradeTags = t.tags.split(',').map(tag => tag.trim());
                                    // A trade is "other" if *none* of its tags are in the top/bottom list
                                    return !tradeTags.some(tag => tagsToExclude.includes(tag));
                                });
                            }
                            break;
                        case 'day':
                            const dayMap = { 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5 };
                            const dayIndex = dayMap[chartFilter.value];
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'trade' && dayjs(t.close).day() === dayIndex);
                            break;
                        case 'pnlRange':
                            const [min, max] = chartFilter.value;
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'trade' && t.pnl >= min && t.pnl < max);
                            break;
                    }
                } else if (selectedCalendarDate) {
                    filteredActivity = allTransactions.filter(item => {
                        const itemDate = getItemDate(item);
                        return itemDate.isSame(selectedCalendarDate, 'day');
                    });
                } else {
                    // Category filter
                    switch(tradeTableFilter) {
                        case 'trades':
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'trade');
                            break;
                        case 'deposits':
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'deposit');
                            break;
                        case 'withdrawals':
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'withdrawal');
                            break;
                        case 'winners':
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'trade' && t.pnl > 0);
                            break;
                        case 'losers':
                            filteredActivity = allTransactions.filter(t => t.transaction_type === 'trade' && t.pnl <= 0);
                            break;
                        case 'all':
                        default:
                            filteredActivity = allTransactions;
                            break;
                    }
                }
                
                // Search filter (applies on top of other filters)
                if (logSearchFilter) {
                    filteredActivity = filteredActivity.filter(item => {
                        if (item.transaction_type === 'trade') {
                            return item.ticker.toLowerCase().includes(logSearchFilter) || 
                                 (item.tags && item.tags.toLowerCase().includes(logSearchFilter));
                        }
                        if (item.notes) {
                            return item.notes.toLowerCase().includes(logSearchFilter);
                        }
                        return false; 
                    });
                }

                // Sorting logic
                filteredActivity.sort((a, b) => {
                    let compare = 0;
                    let valA, valB;

                    switch (sortBy) {
                        case 'date':
                            valA = getItemDate(a);
                            valB = getItemDate(b);
                            compare = valA.diff(valB);
                            break;
                        case 'duration':
                            valA = a.transaction_type === 'trade' ? dayjs(a.close).diff(dayjs(a.open), 'day') : -1;
                            valB = b.transaction_type === 'trade' ? dayjs(b.close).diff(dayjs(b.open), 'day') : -1;
                            compare = valA - valB;
                            break;
                        case 'amount':
                            valA = a.transaction_type === 'trade' ? a.pnl : (a.transaction_type === 'deposit' ? a.amount : -a.amount);
                            valB = b.transaction_type === 'trade' ? b.pnl : (b.transaction_type === 'deposit' ? b.amount : -b.amount);
                            compare = valA - valB;
                            break;
                        case 'roc':
                            valA = (a.transaction_type === 'trade' && a.max_risk > 0) ? (calculateRawPnl(a) / a.max_risk) : -Infinity;
                            valB = (b.transaction_type === 'trade' && b.max_risk > 0) ? (calculateRawPnl(b) / b.max_risk) : -Infinity;
                            compare = valA - valB;
                            break;
                    }

                    // Apply primary sort direction
                    if (sortDirection === 'desc') {
                        compare = -compare;
                    }
                    
                    // If primary sort is a tie, use ID as a secondary, stable sort, respecting the primary direction
                    if (compare === 0) {
                        return sortDirection === 'desc' ? b.id - a.id : a.id - b.id;
                    }

                    return compare;
                });

                // Update sort indicators in the header
                document.querySelectorAll('.sort-indicator').forEach(span => span.textContent = '');
                const activeIndicator = document.querySelector(`.sort-btn[data-sort="${sortBy}"] .sort-indicator`);
                if (activeIndicator) {
                    activeIndicator.textContent = sortDirection === 'asc' ? ' ▲' : ' ▼';
                }

                const filterSpan = chartFilterDisplay.querySelector('span');
                if (chartFilter.type) {
                    chartFilterDisplay.classList.remove('hidden');
                    const displayValue = chartFilter.displayValue || chartFilter.value;
                    let typeDisplay = chartFilter.type.charAt(0).toUpperCase() + chartFilter.type.slice(1);
                    if (typeDisplay === 'PnlRange') typeDisplay = 'P&L Range';
                    if (typeDisplay === 'OtherTickers') typeDisplay = 'Ticker';
                    if (typeDisplay === 'OtherTags') typeDisplay = 'Tag';

                    filterSpan.textContent = `${typeDisplay}: ${displayValue}`;
                } else {
                    chartFilterDisplay.classList.add('hidden');
                }
                
                filteredActivityForExport = filteredActivity; // Save for export function
                
                // Calculate totals for the entire filtered list (before pagination)
                const totalAmount = filteredActivity.reduce((acc, item) => {
                    if (item.transaction_type === 'trade') return acc + item.pnl;
                    if (item.transaction_type === 'deposit') return acc + item.amount;
                    if (item.transaction_type === 'withdrawal') return acc - item.amount;
                    return acc;
                }, 0);

                const totalRocTrades = filteredActivity.filter(t => t.transaction_type === 'trade' && t.max_risk > 0);
                const avgRocTotal = totalRocTrades.length > 0 ? (totalRocTrades.reduce((acc, t) => acc + (calculateRawPnl(t) / t.max_risk), 0) / totalRocTrades.length) * 100 : 0;

                // Pagination Logic
                const totalPages = Math.ceil(filteredActivity.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedActivity = filteredActivity.slice(startIndex, endIndex);

                tradesBody.innerHTML = '';
                paginatedActivity.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-700/50 cursor-pointer text-sm';
                    row.dataset.id = item.id;
                    
                    let date, type, description, amount, amountColor, duration = 'N/A', roc = 'N/A';
                    
                    const itemDate = getItemDate(item);

                    if (item.transaction_type === 'trade') {
                        date = itemDate.format('YYYY-MM-DD');
                        type = 'Trade';
                        
                        let strikeDescription = '';
                        if (item.strikes && item.strikes.length > 0) {
                            strikeDescription = item.strikes.join('/');
                        }
                        description = `${item.ticker} ${strikeDescription} ${item.type}`;

                        amount = item.pnl;
                        amountColor = item.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                        duration = dayjs(item.close).diff(dayjs(item.open), 'day') + 'd';
                        if (item.max_risk > 0) {
                            roc = `${((calculateRawPnl(item) / item.max_risk) * 100).toFixed(1)}%`;
                        }
                    } else {
                        date = itemDate.format('YYYY-MM-DD');
                        type = item.isInitial ? 'Initial Deposit' : item.transaction_type.charAt(0).toUpperCase() + item.transaction_type.slice(1);
                        description = item.notes || type;
                        amount = item.transaction_type === 'deposit' ? item.amount : -item.amount;
                        amountColor = item.transaction_type === 'deposit' ? 'text-blue-400' : 'text-orange-400';
                    }

                    row.innerHTML = `
                        <td class="p-3 text-gray-400">${date}</td>
                        <td class="p-3 font-semibold">${type}</td>
                        <td class="p-3 text-gray-400">${description}</td>
                        <td class="p-3 text-gray-400 text-right hidden md:table-cell">${duration}</td>
                        <td class="p-3 text-right font-mono ${amountColor}">${amount >= 0 ? '+' : ''}${formatCurrency(amount)}</td>
                        <td class="p-3 text-right font-mono ${amountColor} hidden lg:table-cell">${roc}</td>
                        <td class="p-3 text-right pr-4">
                            ${item.transaction_type === 'trade' ? 
                            `<button class="edit-btn p-1 text-gray-400 hover:text-white" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>` : ''}
                            ${!item.isInitial ? `<button class="delete-btn p-1 text-gray-400 hover:text-red-500" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>`: ''}
                        </td>
                    `;
                    tradesBody.appendChild(row);
                });
                
                // Render Footer
                const totalAmountColor = totalAmount >= 0 ? 'text-green-400' : 'text-red-400';
                activityLogFooter.innerHTML = `
                    <td class="p-3" colspan="3"></td>
                    <td class="p-3 text-right hidden md:table-cell">Total:</td>
                    <td class="p-3 text-right font-mono ${totalAmountColor}">${formatCurrency(totalAmount)}</td>
                    <td class="p-3 text-right font-mono ${avgRocTotal >= 0 ? 'text-green-400' : 'text-red-400'} hidden lg:table-cell">${avgRocTotal.toFixed(1)}%</td>
                    <td class="pr-4"></td>
                `;
                
                // Render Pagination
                paginationControls.innerHTML = '';
                if (totalPages > 1) {
                    paginationControls.innerHTML = `
                        <button id="prev-page-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                        <span>Page ${currentPage} of ${totalPages}</span>
                        <button id="next-page-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition disabled:opacity-50" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                    `;
                    document.getElementById('prev-page-btn').addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            updateDashboard();
                        }
                    });
                     document.getElementById('next-page-btn').addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            updateDashboard();
                        }
                    });
                }
            }
            
            function updateAnalyticsCharts(trades) {
                const analyticsChartOptions = {
                    maintainAspectRatio: false, 
                    responsive: true,
                    barThickness: 15,
                    scales: { 
                        y: { 
                            ticks: { color: '#9ca3af' }, 
                            grid: { color: 'rgba(75, 85, 99, 0.5)', zeroLineColor: '#6b7280' },
                            border: { display: false }
                        }, 
                        x: { 
                            ticks: { color: '#9ca3af' },
                            grid: { display: false },
                            border: { display: false }
                        } 
                    }, 
                    plugins: { legend: { display: false } }
                };

                 const horizontalAnalyticsChartOptions = {
                    ...analyticsChartOptions,
                    indexAxis: 'y',
                    scales: { 
                        x: { 
                            ticks: { color: '#9ca3af' }, 
                            grid: { color: 'rgba(75, 85, 99, 0.5)', zeroLineColor: '#6b7280' },
                            border: { display: false }
                        }, 
                        y: { 
                            ticks: { color: '#9ca3af' },
                            grid: { display: false },
                            border: { display: false }
                        } 
                    }, 
                };

                function processAndLimitChartData(dataObject, limit = 12, topN = 5, bottomN = 5) {
                    let dataArray = Object.entries(dataObject).map(([label, pnl]) => ({ label, pnl }));

                    if (dataArray.length <= limit) {
                        dataArray.sort((a, b) => b.pnl - a.pnl);
                        return {
                            labels: dataArray.map(d => d.label),
                            data: dataArray.map(d => d.pnl),
                            topAndBottomLabels: dataArray.map(d => d.label) // All labels are top/bottom if not exceeding limit
                        };
                    }

                    dataArray.sort((a, b) => b.pnl - a.pnl);

                    const topItems = dataArray.slice(0, topN);
                    const bottomItems = dataArray.slice(dataArray.length - bottomN);
                    const middleItems = dataArray.slice(topN, dataArray.length - bottomN);
                    
                    const otherPnl = middleItems.reduce((acc, item) => acc + item.pnl, 0);

                    let finalArray = [...topItems];
                    if (middleItems.length > 0) {
                        finalArray.push({ label: 'Other', pnl: otherPnl });
                    }
                    finalArray = [...finalArray, ...bottomItems];

                    // Don't re-sort here, keep Top -> Other -> Bottom order visually
                    // finalArray.sort((a, b) => b.pnl - a.pnl);
                    
                    // These are the labels *not* included in "Other"
                    const topAndBottomLabels = [...topItems, ...bottomItems].map(d => d.label);

                    return {
                        labels: finalArray.map(d => d.label),
                        data: finalArray.map(d => d.pnl),
                        topAndBottomLabels: topAndBottomLabels 
                    };
                }


                // P&L by Ticker
                const pnlByTicker = trades.reduce((acc, trade) => {
                    if (!acc[trade.ticker]) acc[trade.ticker] = 0;
                    acc[trade.ticker] += trade.pnl;
                    return acc;
                }, {});

                const tickerChartData = processAndLimitChartData(pnlByTicker);

                if (pnlByTickerChart) pnlByTickerChart.destroy();
                pnlByTickerChart = new Chart(document.getElementById('pnlByTickerChart'), {
                    type: 'bar', data: {
                        labels: tickerChartData.labels,
                        datasets: [{ label: 'Total P&L', data: tickerChartData.data, backgroundColor: tickerChartData.data.map(pnl => pnl >= 0 ? 'rgba(74, 222, 128, 0.7)' : 'rgba(248, 113, 113, 0.7)') }]
                    },
                    options: { ...horizontalAnalyticsChartOptions, onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const clickedLabel = event.chart.data.labels[elementIndex];
                            if (clickedLabel === 'Other') {
                                setChartFilter('otherTickers', tickerChartData.topAndBottomLabels, 'Other');
                            } else {
                                setChartFilter('ticker', clickedLabel);
                            }
                        }
                    }}
                });

                // P&L by Tag
                const pnlByTag = trades.reduce((acc, trade) => {
                    const tags = trade.tags ? trade.tags.split(',').map(t => t.trim()) : [];
                    tags.forEach(tag => {
                        if(tag) {
                           if (!acc[tag]) acc[tag] = 0;
                           acc[tag] += trade.pnl;
                        }
                    });
                    return acc;
                }, {});

                const tagChartData = processAndLimitChartData(pnlByTag);

                if (pnlByTagChart) pnlByTagChart.destroy();
                pnlByTagChart = new Chart(document.getElementById('pnlByTagChart'), {
                    type: 'bar', data: {
                        labels: tagChartData.labels,
                        datasets: [{ label: 'Total P&L', data: tagChartData.data, backgroundColor: tagChartData.data.map(pnl => pnl >= 0 ? 'rgba(96, 165, 250, 0.7)' : 'rgba(251, 146, 60, 0.7)') }]
                    },
                    options: { ...horizontalAnalyticsChartOptions, onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const clickedLabel = event.chart.data.labels[elementIndex];
                             if (clickedLabel === 'Other') {
                                setChartFilter('otherTags', tagChartData.topAndBottomLabels, 'Other');
                            } else {
                                setChartFilter('tag', clickedLabel);
                            }
                        }
                    }}
                });

                // P&L by Day of Week
                const pnlByDay = { 'Mon': 0, 'Tue': 0, 'Wed': 0, 'Thu': 0, 'Fri': 0 };
                trades.forEach(trade => {
                    const day = dayjs(trade.close).day(); // 0 for Sunday, 1 for Monday, etc.
                    if (day > 0 && day < 6) { // Only count weekdays
                        const dayName = Object.keys(pnlByDay)[day - 1];
                        pnlByDay[dayName] += trade.pnl;
                    }
                });
                if (pnlByDayChart) pnlByDayChart.destroy();
                pnlByDayChart = new Chart(document.getElementById('pnlByDayChart'), {
                    type: 'bar', data: {
                        labels: Object.keys(pnlByDay),
                        datasets: [{ label: 'Total P&L', data: Object.values(pnlByDay), backgroundColor: Object.values(pnlByDay).map(pnl => pnl >= 0 ? 'rgba(52, 211, 153, 0.7)' : 'rgba(251, 113, 133, 0.7)') }]
                    },
                     options: { ...analyticsChartOptions, onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const clickedLabel = event.chart.data.labels[elementIndex];
                            setChartFilter('day', clickedLabel);
                        }
                    }}
                });
                
                // P&L Distribution
                const pnlValues = trades.map(t => t.pnl);
                const maxPnl = Math.max(0.01, ...pnlValues.map(Math.abs));
                const binSize = Math.max(10, Math.ceil(maxPnl / 10 / 100) * 100); // Round to nearest 100, min bin size 10
                const bins = {};
                pnlValues.forEach(pnl => {
                    const bin = Math.floor(pnl / binSize) * binSize;
                    if(!bins[bin]) bins[bin] = 0;
                    bins[bin]++;
                });
                const sortedBins = Object.keys(bins).sort((a,b) => a-b);
                const binLabels = sortedBins.map(b => `${formatCurrency(parseInt(b))} to ${formatCurrency(parseInt(b) + binSize)}`);
                const binData = sortedBins.map(b => bins[b]);

                if (pnlDistributionChart) pnlDistributionChart.destroy();
                pnlDistributionChart = new Chart(document.getElementById('pnlDistributionChart'), {
                    type: 'bar',
                    data: {
                        labels: binLabels,
                        datasets: [{
                            label: '# of Trades',
                            data: binData,
                            backgroundColor: sortedBins.map(b => parseInt(b) + binSize/2 >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)')
                        }]
                    },
                    options: { maintainAspectRatio: false, responsive: true, scales: { y: { ticks: { color: '#9ca3af', stepSize: 1 }, title: { display: true, text: 'Number of Trades', color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { display: false } },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const elementIndex = elements[0].index;
                                const clickedBinStart = parseInt(sortedBins[elementIndex]);
                                const range = [clickedBinStart, clickedBinStart + binSize];
                                const displayValue = `${formatCurrency(range[0])} to ${formatCurrency(range[1])}`;
                                setChartFilter('pnlRange', range, displayValue);
                            }
                        },
                    }
                });
            }

            // --- CALENDAR FUNCTIONS ---
            function renderCalendar() {
                try { // Add a try...catch block for better error reporting
                    // console.log("[Calendar Render] Starting renderCalendar...");
                    const allTransactions = getActiveTransactions();
                    const trades = allTransactions.filter(t => t.transaction_type === 'trade');
                    // console.log(`[Calendar Render] Found ${trades.length} trades.`);

                    // **Modify dailyData to store sorted trades**
                    const dailyData = trades.reduce((acc, trade) => {
                        const closeDate = dayjs(trade.close).format('YYYY-MM-DD');
                        if (!acc[closeDate]) {
                            // Initialize with an empty trades array
                            acc[closeDate] = { pnl: 0, trades: [] };
                        }
                        // Add safety check for pnl
                        acc[closeDate].pnl += (trade.pnl || 0); // Use 0 if pnl is undefined/NaN
                        // Add the full trade object
                        acc[closeDate].trades.push(trade);
                        return acc;
                    }, {});
                    // console.log("[Calendar Render] dailyData created:", dailyData);


                    // **Sort trades within each day by ID (entry order)**
                    Object.values(dailyData).forEach(dayData => {
                        dayData.trades.sort((a, b) => a.id - b.id);
                    });
                    // console.log("[Calendar Render] Trades within dailyData sorted.");


                    calendarGrid.innerHTML = '';
                    let periodPnl = 0;

                    if (calendarView === 'month') {
                        calendarGrid.classList.remove('grid-cols-7');
                        calendarGrid.classList.add('md:grid-cols-8', 'grid-cols-7');
                        calendarPeriodLabel.textContent = calendarDate.format('MMMM YYYY');
                        const startOfMonth = calendarDate.startOf('month');
                        const daysInMonth = calendarDate.daysInMonth();
                        const startDay = startOfMonth.day();

                        const headers = ['S', 'M', 'T', 'W', 'T', 'F', 'S', '<span class="hidden md:inline">Weekly</span>'];
                        calendarGrid.innerHTML = headers.map((day, i) => `<div class="font-bold text-xs text-gray-500 p-2 ${i === 7 ? 'text-right' : ''} ${i === 7 ? 'hidden md:block' : ''}">${day}</div>`).join('');

                        for (let i = 0; i < startDay; i++) {
                            calendarGrid.innerHTML += '<div></div>';
                        }

                        let weeklyPnl = 0;
                        for (let i = 1; i <= daysInMonth; i++) {
                            const day = startOfMonth.date(i);
                            const dateStr = day.format('YYYY-MM-DD');
                            // Use default with trades array if no data
                            const data = dailyData[dateStr] || { pnl: 0, trades: [] };
                             // console.log(`[Calendar Render] Processing Day ${i}:`, data); // Log data for each day
                            periodPnl += data.pnl;
                            weeklyPnl += data.pnl;

                            let bgColor = 'bg-gray-700/50';
                            if (data.pnl > 0) bgColor = `rgba(34, 197, 94, ${Math.min(0.2 + data.pnl / 1000, 1)})`;
                            if (data.pnl < 0) bgColor = `rgba(239, 68, 68, ${Math.min(0.2 + Math.abs(data.pnl) / 1000, 1)})`;

                            const isToday = day.isSame(dayjs(), 'day');
                            const isWeekend = day.day() === 0 || day.day() === 6;
                            const isSelected = selectedCalendarDate && day.isSame(selectedCalendarDate, 'day');
                            const hasTrades = data.trades.length > 0; // Check trades array length
                            const isClickable = !isWeekend && hasTrades;

                            // **Generate dots by iterating through sorted trades**
                            let tradeDots = '';
                            if (hasTrades) {
                                tradeDots = '<div class="flex flex-wrap mt-1">';
                                data.trades.forEach((trade, index) => {
                                    // Add safety check for trade.pnl before generating dot
                                    if (typeof trade.pnl === 'number') {
                                        const dotColor = trade.pnl > 0 ? 'bg-green-400' : 'bg-red-400';
                                        tradeDots += `<div class="h-1.5 w-1.5 ${dotColor} rounded-full mr-1 mb-1"></div>`;
                                    } else {
                                        console.warn(`[Calendar Render] Invalid PnL found for trade on ${dateStr}, index ${index}:`, trade);
                                        // Optionally add a placeholder dot for invalid PnL
                                        tradeDots += `<div class="h-1.5 w-1.5 bg-gray-500 rounded-full mr-1 mb-1" title="Invalid PnL"></div>`;
                                    }
                                });
                                tradeDots += '</div>';
                                // console.log(`[Calendar Render] Day ${i} - Trade Dots HTML: ${tradeDots}`); // Log generated dots HTML
                            }


                            calendarGrid.innerHTML += `
                                <div class="calendar-day p-1 sm:p-2 rounded-lg text-left flex flex-col border-2 transition ${isToday ? 'border-indigo-500/50' : 'border-transparent'} ${isSelected ? '!border-indigo-500' : ''} ${isWeekend ? 'bg-gray-800/50 text-gray-600' : (isClickable ? 'cursor-pointer' : '')}"
                                     style="${!isWeekend ? `background-color: ${bgColor};` : ''}"
                                     data-date="${dateStr}">
                                    <span class="font-semibold text-xs sm:text-sm ${isToday ? 'text-indigo-400' : ''}">${i}</span>
                                    ${tradeDots}
                                    ${data.pnl !== 0 ? `<span class="calendar-pnl-text mt-auto font-bold ${data.pnl > 0 ? 'text-green-300' : 'text-red-300'}">${formatCurrency(data.pnl)}</span>` : ''}
                                </div>`;

                            if (day.day() === 6 ) { // If it's a Saturday
                                const pnlColor = weeklyPnl > 0 ? 'text-green-400' : weeklyPnl < 0 ? 'text-red-400' : 'text-gray-400';
                                calendarGrid.innerHTML += `<div class="hidden md:flex items-center justify-end font-semibold text-xs pr-2 ${pnlColor}">${formatCurrency(weeklyPnl)}</div>`;
                                weeklyPnl = 0;
                            }
                        }

                        // After loop, handle the final week if month doesn't end on Saturday
                        const lastDayOfMonth = calendarDate.endOf('month');
                        if(lastDayOfMonth.day() !== 6) {
                            for (let j = lastDayOfMonth.day(); j < 6; j++) {
                               calendarGrid.innerHTML += '<div class="hidden md:block"></div>';
                            }
                            const pnlColor = weeklyPnl > 0 ? 'text-green-400' : weeklyPnl < 0 ? 'text-red-400' : 'text-gray-400';
                            calendarGrid.innerHTML += `<div class="hidden md:flex items-center justify-end font-semibold text-xs pr-2 ${pnlColor}">${formatCurrency(weeklyPnl)}</div>`;
                        }


                    } else { // Week view
                        calendarGrid.classList.remove('grid-cols-8');
                        calendarGrid.classList.add('grid-cols-7');
                        const startOfWeek = calendarDate.startOf('week');
                        const endOfWeek = calendarDate.endOf('week');
                        calendarPeriodLabel.textContent = `${startOfWeek.format('MMM D')} - ${endOfWeek.format('MMM D, YYYY')}`;

                        const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                        calendarGrid.innerHTML = days.map(day => `<div class="font-bold text-xs text-gray-500 p-2">${day}</div>`).join('');

                        for (let i = 0; i < 7; i++) {
                            const day = startOfWeek.add(i, 'day');
                            const dateStr = day.format('YYYY-MM-DD');
                            // Use default with trades array if no data
                            const data = dailyData[dateStr] || { pnl: 0, trades: [] };
                            periodPnl += data.pnl;

                            let bgColor = 'bg-gray-700/50';
                            if (data.pnl > 0) bgColor = `rgba(34, 197, 94, ${Math.min(0.2 + data.pnl / 1000, 1)})`;
                            if (data.pnl < 0) bgColor = `rgba(239, 68, 68, ${Math.min(0.2 + Math.abs(data.pnl) / 1000, 1)})`;

                            const isToday = day.isSame(dayjs(), 'day');
                            const isWeekend = day.day() === 0 || day.day() === 6;
                            const isSelected = selectedCalendarDate && day.isSame(selectedCalendarDate, 'day');
                            const hasTrades = data.trades.length > 0; // Check trades array length
                            const isClickable = !isWeekend && hasTrades;

                            // **Generate dots by iterating through sorted trades**
                            let tradeDots = '';
                            if (hasTrades) {
                                tradeDots = '<div class="flex flex-wrap mt-1">';
                                data.trades.forEach((trade, index) => {
                                    // Add safety check for trade.pnl before generating dot
                                    if (typeof trade.pnl === 'number') {
                                        const dotColor = trade.pnl > 0 ? 'bg-green-400' : 'bg-red-400';
                                        tradeDots += `<div class="h-1.5 w-1.5 ${dotColor} rounded-full mr-1 mb-1"></div>`;
                                    } else {
                                        console.warn(`[Calendar Render] Invalid PnL found for trade on ${dateStr}, index ${index}:`, trade); // Fixed missing parenthesis
                                        tradeDots += `<div class="h-1.5 w-1.5 bg-gray-500 rounded-full mr-1 mb-1" title="Invalid PnL"></div>`;
                                    }
                                });
                                tradeDots += '</div>';
                            }

                            calendarGrid.innerHTML += `
                                <div class="calendar-day p-1 sm:p-2 rounded-lg text-left flex flex-col border-2 transition ${isToday ? 'border-indigo-500/50' : 'border-transparent'} ${isSelected ? '!border-indigo-500' : ''} ${isWeekend ? 'bg-gray-800/50 text-gray-600' : (isClickable ? 'cursor-pointer' : '')}"
                                     style="${!isWeekend ? `background-color: ${bgColor};` : ''}"
                                     data-date="${dateStr}">
                                    <span class="font-semibold text-xs sm:text-sm ${isToday ? 'text-indigo-400' : ''}">${day.format('D')}</span>
                                    ${tradeDots}
                                    ${data.pnl !== 0 ? `<span class="calendar-pnl-text mt-auto font-bold ${data.pnl > 0 ? 'text-green-300' : 'text-red-300'}">${formatCurrency(data.pnl)}</span>` : ''}
                                </div>`;
                        }
                    }
                     calendarSummary.textContent = `Period P&L: ${formatCurrency(periodPnl)}`;
                     // console.log("[Calendar Render] Finished renderCalendar successfully.");
                } catch (error) {
                    console.error("[Calendar Render] Error during calendar rendering:", error);
                    // Optionally display an error message to the user in the UI
                    calendarGrid.innerHTML = `<div class="col-span-7 text-center text-red-400 p-4">Error loading calendar. Please check the console.</div>`;
                }
            }

            calendarGrid.addEventListener('click', (e) => {
                const dayEl = e.target.closest('.calendar-day');
                if (dayEl && dayEl.dataset.date && dayEl.classList.contains('cursor-pointer')) {
                    const date = dayEl.dataset.date;
                    // Toggle selection
                    selectedCalendarDate = selectedCalendarDate === date ? null : date;
                    
                    // Clear other filter types
                    chartFilter = { type: null, value: null, displayValue: null }; 
                    tradeTableFilter = 'all';
                    document.querySelectorAll('#trade-filters .filter-btn').forEach(btn => {
                        const isAllButton = btn.dataset.filter === 'all';
                        btn.classList.toggle('bg-indigo-600', isAllButton);
                        btn.classList.toggle('text-white', isAllButton);
                        btn.classList.toggle('bg-gray-700', !isAllButton);
                        btn.classList.toggle('text-gray-300', !isAllButton);
                    });

                    currentPage = 1;
                    updateDashboard();
                }
            });

            unfilterDayBtn.addEventListener('click', () => {
                selectedCalendarDate = null;
                updateDashboard();
            });

            prevPeriodBtn.addEventListener('click', () => {
                calendarDate = calendarDate.subtract(1, calendarView);
                renderCalendar();
            });

            nextPeriodBtn.addEventListener('click', () => {
                calendarDate = calendarDate.add(1, calendarView);
                renderCalendar();
            });

            calendarMonthWeekToggle.addEventListener('click', (e) => {
                const btn = e.target.closest('.calendar-view-btn');
                if (!btn) return;
                calendarView = btn.dataset.view;
                document.querySelectorAll('#calendar-view-toggle-buttons .calendar-view-btn').forEach(b => {
                    b.classList.remove('bg-indigo-600', 'text-white');
                    b.classList.add('bg-gray-700', 'text-gray-300');
                });
                btn.classList.add('bg-indigo-600', 'text-white');
                btn.classList.remove('bg-gray-700', 'text-gray-300');
                renderCalendar();
            });
            
            window.addEventListener('resize', () => {
                if (mainView === 'calendar') {
                    renderCalendar();
                }
            });

            function exportActivityLogToCSV() {
                const headers = ['Date', 'Type', 'Description', 'Duration (Days)', 'Amount', 'ROC %', 'Notes', 'Tags'];
                const rows = filteredActivityForExport.map(item => {
                    let rowData;
                     if (item.transaction_type === 'trade') {
                        rowData = [
                            dayjs(item.close).format('YYYY-MM-DD'),
                            'Trade',
                            `"${item.type} on ${item.ticker}"`,
                            dayjs(item.close).diff(dayjs(item.open), 'day'),
                            item.pnl.toFixed(2),
                            item.max_risk > 0 ? `${((calculateRawPnl(item) / item.max_risk) * 100).toFixed(1)}%` : 'N/A',
                            `"${(item.notes || '').replace(/"/g, '""')}"`,
                            `"${(item.tags || '').replace(/"/g, '""')}"`
                        ];
                    } else {
                         rowData = [
                            dayjs(item.date).format('YYYY-MM-DD'),
                            item.isInitial ? 'Initial Deposit' : item.transaction_type.charAt(0).toUpperCase() + item.transaction_type.slice(1),
                            `"${(item.notes || '').replace(/"/g, '""')}"`,
                            'N/A',
                            (item.transaction_type === 'deposit' ? item.amount : -item.amount).toFixed(2),
                             'N/A',
                             'N/A',
                             'N/A'
                        ];
                    }
                    return rowData.join(',');
                });

                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `activity_log_${getActiveAccount().name.replace(' ','_')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- Function to generate dummy data ---
            function generateDummyData() {
                const startDate = dayjs('2025-07-01');
                const endDate = dayjs('2025-09-30');
                const data = [];
                const tickers = ['SPY', 'QQQ', 'AAPL', 'TSLA', 'NVDA', 'AMD', 'GOOG'];
                const strategies = Object.keys(strategyDetails);
                const tags = ['earnings', 'swing', '0DTE', 'theta', 'lotto', 'momentum'];

                const getRandomWeekday = (start, end) => {
                    let date;
                    do {
                        const randomDay = Math.random() * end.diff(start, 'day');
                        date = start.add(randomDay, 'day');
                    } while (date.day() === 0 || date.day() === 6);
                    return date;
                };

                data.push({ id: 0, transaction_type: 'deposit', amount: 25000, date: '2025-07-01', notes: 'Initial Deposit', isInitial: true });

                for (let i = 1; i <= 60; i++) {
                    const openDate = getRandomWeekday(startDate, endDate.subtract(1, 'week'));
                    const closeDate = getRandomWeekday(openDate.add(1, 'day'), openDate.add(2, 'weeks'));
                    const entryPrice = parseFloat((Math.random() * 5 + 0.5).toFixed(2));
                    let exitPrice;
                    const isWinner = Math.random() > 0.45; // 55% win rate
                    
                    if (isWinner) {
                        exitPrice = parseFloat((entryPrice * (1 + (Math.random() * 1.5 + 0.2))).toFixed(2));
                    } else {
                        exitPrice = parseFloat((entryPrice * (1 - (Math.random() * 0.8 + 0.1))).toFixed(2));
                    }
                    
                    const type = strategies[Math.floor(Math.random() * strategies.length)];
                    const details = strategyDetails[type];
                    let strikes = [];
                    const startStrike = 100 + Math.floor(Math.random() * 50);
                    for (let j = 0; j < details.strikes.length; j++) {
                        strikes.push(startStrike + (j * 5)); // e.g., 150, 155, 160...
                    }

                    const trade = {
                        id: i,
                        transaction_type: 'trade',
                        ticker: tickers[Math.floor(Math.random() * tickers.length)],
                        type: type,
                        open: openDate.format('YYYY-MM-DD'),
                        close: closeDate.format('YYYY-MM-DD'),
                        expiration: closeDate.add(Math.floor(Math.random() * 20) + 5, 'day').format('YYYY-MM-DD'),
                        strikes: strikes,
                        quantity: Math.floor(Math.random() * 5) + 1,
                        entry_price: entryPrice,
                        exit_price: exitPrice,
                        commissions: 0.65,
                        opening_commission: null,
                        closing_commission: null,
                        max_risk: (entryPrice * 100) * (Math.floor(Math.random() * 5) + 1),
                        tags: tags[Math.floor(Math.random() * tags.length)],
                        notes: 'Sample trade data.',
                        isExpired: Math.random() > 0.9,
                        ratio: details.ratio === true,
                        expiration_2: details.expirations === 2 ? closeDate.add(Math.floor(Math.random() * 20) + 28, 'day').format('YYYY-MM-DD') : null,
                        quantity_2: details.ratio === true ? (Math.floor(Math.random() * 5) + 1) * 2 : null,
                        entry_price_2: details.ratio === true ? parseFloat((entryPrice * 0.7).toFixed(2)) : null,
                        exit_price_2: details.ratio === true ? parseFloat((exitPrice * 0.6).toFixed(2)) : null,
                    };

                    trade.pnl = calculatePnl(trade); // Recalculate PNL with commissions
                    data.push(trade);
                }
                return data;
            }

            // Initial dashboard load
            initialize();
        });
        
        // Start Firebase initialization as soon as the script runs
        initializeFirebase();

    </script>
</body>
</html>

